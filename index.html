<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Diagrama Hombre-MÃ¡quina â€” Avanzado (Intervalo 0.5 min)</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
<style>
Â  :root{
Â  Â  --bg:#f6f7f9; --card:#fff; --muted:#6c757d;
Â  Â  --accent:#0d6efd; --danger:#dc3545;
Â  Â  --border:#dee2e6;
Â  }
Â  html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial; background:var(--bg); color:#222}
Â  .app{max-width:1600px;margin:18px auto;padding:18px;background:var(--card);border-radius:10px;box-shadow:0 4px 22px rgba(0,0,0,0.06)}
Â  h1{margin:0 0 12px}
Â  .row{display:flex;gap:12px;align-items:flex-start}
Â  .col{flex:1}
Â  .panel{background:#fff;border:1px solid var(--border);padding:12px;border-radius:8px}
Â  .controls{display:flex;gap:8px;flex-wrap:wrap}
Â  input,select,button{font-size:14px}
Â  button{cursor:pointer;padding:8px 10px;border-radius:6px;border:none;color:#fff}
Â  .btn-primary{background:var(--accent)}
Â  .btn-danger{background:var(--danger)}
Â  .btn-secondary{background:var(--muted); color:#fff}
Â  #acciones-disponibles{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
Â  .accion-wrapper{position:relative;display:inline-block;}
Â  .btn-delete-action{
Â  Â  position:absolute; top:-8px; right:-8px; background:var(--danger); color:white;
Â  Â  border-radius:50%; width:18px; height:18px; font-size:12px; line-height:18px;
Â  Â  text-align:center; cursor:pointer; border:1px solid white;
Â  }

Â  /* tabla */
Â  .tabla-contenedor{overflow:auto;border:1px solid var(--border);border-radius:6px;margin-top:12px;position:relative}
Â  table{border-collapse:collapse;width:100%;transform-origin:top left}
Â  thead th{position:sticky;top:0;background:#f1f3f5;padding:8px;border:1px solid var(--border); cursor:pointer;}
Â  td,th{min-width:72px;padding:6px;text-align:center;border:1px solid var(--border)}
Â  tbody td:first-child{background:#fafafa;font-weight:600}
Â  .celda-inactiva{background-image:repeating-linear-gradient(45deg, rgba(220,53,69,0.06), rgba(220,53,69,0.06) 8px, transparent 8px, transparent 16px)}
Â  /* tooltip */
Â  #tooltip{position:fixed;background:#222;color:#fff;padding:6px 8px;border-radius:6px;pointer-events:none;opacity:0;transition:opacity .12s;z-index:2000;font-size:13px}

Â  /* modal */
Â  .modal{position:fixed;left:0;top:0;width:100%;height:100%;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);z-index:2000}
Â  .modal .card{background:#fff;padding:16px;border-radius:10px;min-width:300px;max-width:420px}
Â  .modal input, .modal select{width:100%;padding:8px;margin-top:8px;border:1px solid var(--border);border-radius:6px}

Â  /* small utility */
Â  .small{font-size:13px;color:var(--muted)}
Â  .flex{display:flex;gap:8px;align-items:center}
Â  .divider{height:1px;background:var(--border);margin:8px 0;border-radius:2px}

Â  /* drag cue */
Â  .drag-handle{cursor:grab;font-weight:700}

Â  /* patterns: using background images for stripes/dots */
Â  .pattern-stripes{background-image:repeating-linear-gradient(135deg, rgba(0,0,0,0.08) 0 6px, transparent 6px 12px)}
Â  .pattern-dots{background-image:radial-gradient(rgba(0,0,0,0.06) 1px, transparent 1px);background-size:8px 8px}

Â  /* highlight row during animation */
Â  .highlight-row{outline:3px solid rgba(13,110,253,0.18);}

Â  /* responsiveness */
Â  @media (max-width:900px){ .row{flex-direction:column} }
</style>
</head>
<body>
<div id="tooltip"></div>
<div class="app">
Â  <h1>Diagrama Hombre-MÃ¡quina â€” Avanzado</h1>

Â  <div class="row">
Â  Â  <div class="col" style="flex-basis:320px;max-width:360px">
Â  Â  Â  <div class="panel">
Â  Â  Â  Â  <h3>Controles</h3>
Â  Â  Â  Â  <div class="controls">
Â  Â  Â  Â  Â  <label class="small">Minutos: <input id="minutos" type="number" value="60" style="width:80px;margin-left:6px"></label>
Â  Â  Â  Â  Â  <button id="btnGenerar" class="btn-primary">Generar</button>
Â  Â  Â  Â  Â  <button id="btnAgregarMaquina" class="btn-primary">+ MÃ¡quina</button>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="divider"></div>

Â  Â  Â  Â  <h4>Crear acciÃ³n</h4>
Â  Â  Â  Â  <div class="controls">
Â  Â  Â  Â  Â  <input id="nombreAccion" placeholder="Nombre" />
Â  Â  Â  Â  Â  <input id="duracionAccion" type="number" value="1" style="width:70px" min="0.5" step="0.5" />
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div style="display:flex;gap:8px;margin-top:8px">
Â  Â  Â  Â  Â  <input id="colorAccion" type="color" value="#0d6efd" />
Â  Â  Â  Â  Â  <button id="btnCrearAccion" class="btn-primary">Crear</button>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="acciones-disponibles" style="margin-top:12px"></div>

Â  Â  Â  Â  <div class="divider"></div>

Â  Â  Â  Â  <div style="display:flex;gap:8px;flex-wrap:wrap">
Â  Â  Â  Â  Â  <button id="btnGuardar" class="btn-secondary">ğŸ’¾ Guardar JSON</button>
Â  Â  Â  Â  Â  <button id="btnCargar" class="btn-secondary">ğŸ“‚ Cargar JSON</button>
Â  Â  Â  Â  Â  <button id="btnExportPNG" class="btn-secondary">ğŸ–¼ï¸ PNG</button>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
Â  Â  Â  Â  Â  <button id="btnUndo" class="btn-secondary">â†¶ Deshacer</button>
Â  Â  Â  Â  Â  <button id="btnRedo" class="btn-secondary">â†· Rehacer</button>
Â  Â  Â  Â  Â  <button id="btnCopy" class="btn-secondary">Copiar</button>
Â  Â  Â  Â  Â  <button id="btnPaste" class="btn-secondary">Pegar</button>
Â  Â  Â  Â  Â  <button id="btnSplit" class="btn-secondary">Dividir</button>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div style="margin-top:10px">
Â  Â  Â  Â  Â  <label class="small">Zoom: <input id="zoomRange" type="range" min="50" max="150" value="100"></label>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="divider"></div>

Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  <h4>Compartir / Autosave</h4>
Â  Â  Â  Â  Â  <div style="display:flex;gap:8px">
Â  Â  Â  Â  Â  Â  <button id="btnShare" class="btn-secondary">ğŸ”— Generar Link</button>
Â  Â  Â  Â  Â  Â  <button id="btnRestore" class="btn-secondary">â™»ï¸ Restaurar Autosave</button>
Â  Â  Â  Â  Â  Â  <button id="btnClear" class="btn-danger">ğŸ—‘ï¸ Borrar</button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div class="col">
Â  Â  Â  <div class="panel">
Â  Â  Â  Â  <h3>Tabla</h3>
Â  Â  Â  Â  <div class="tabla-contenedor" id="tablaWrapper" style="height:70vh;overflow:auto">
Â  Â  Â  Â  Â  <table id="tabla-actividades">
Â  Â  Â  Â  Â  Â  <thead></thead>
Â  Â  Â  Â  Â  Â  <tbody></tbody>
Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div style="margin-top:8px" class="small">Nota: haz click en cualquier parte de un bloque para editarlo. Arrastra por su tÃ­tulo para moverlo.</div>
Â  Â  Â  </div>

Â  Â  Â  <div class="panel" style="margin-top:12px">
Â  Â  Â  Â  <h3>AnÃ¡lisis</h3>
Â  Â  Â  Â  <div id="analisis-container"></div>
Â  Â  Â  Â  <canvas id="chartCanvas" width="300" height="200" style="display:block;margin-top:8px;border:1px solid var(--border)"></canvas>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>
</div>

<div class="modal" id="modalEditar">
Â  <div class="card">
Â  Â  <h3>Editar bloque</h3>
Â  Â  <div class="small">Editar solo el bloque seleccionado</div>
Â  Â  <input id="modalNombre" placeholder="Nombre" />
Â  Â  <input id="modalDuracion" type="number" min="0.5" step="0.5" placeholder="DuraciÃ³n (min)" />
Â  Â  <input id="modalColor" type="color" />
Â  Â  <div style="display:flex;gap:8px;margin-top:8px">
Â  Â  Â  <button id="modalGuardar" class="btn-primary">Guardar</button>
Â  Â  Â  <button id="modalCancelar" class="btn-danger">Cancelar</button>
Â  Â  Â  <button id="modalBorrar" class="btn-secondary">Borrar bloque</button>
Â  Â  </div>
Â  </div>
</div>

<input id="fileInput" type="file" accept=".json" style="display:none">

<script>
/* --------------------------
Â  Estado y utilidades
---------------------------*/
const tabla = document.getElementById('tabla-actividades');
const thead = tabla.querySelector('thead');
const tbody = tabla.querySelector('tbody');
const minutosInput = document.getElementById('minutos');
const btnGenerar = document.getElementById('btnGenerar');
const btnAgregarMaquina = document.getElementById('btnAgregarMaquina');
const accionesDiv = document.getElementById('acciones-disponibles');
const btnCrearAccion = document.getElementById('btnCrearAccion');
const inputNombreAccion = document.getElementById('nombreAccion');
const inputDuracionAccion = document.getElementById('duracionAccion');
const inputColorAccion = document.getElementById('colorAccion');

const btnGuardar = document.getElementById('btnGuardar');
const btnCargar = document.getElementById('btnCargar');
const fileInput = document.getElementById('fileInput');
const btnExportPNG = document.getElementById('btnExportPNG');

const btnUndo = document.getElementById('btnUndo');
const btnRedo = document.getElementById('btnRedo');
const btnCopy = document.getElementById('btnCopy');
const btnPaste = document.getElementById('btnPaste');
const btnSplit = document.getElementById('btnSplit');

const zoomRange = document.getElementById('zoomRange');
const btnShare = document.getElementById('btnShare');
const btnRestore = document.getElementById('btnRestore');
const btnClear = document.getElementById('btnClear');

const modal = document.getElementById('modalEditar');
const modalNombre = document.getElementById('modalNombre');
const modalDuracion = document.getElementById('modalDuracion');
const modalColor = document.getElementById('modalColor');
const modalGuardar = document.getElementById('modalGuardar');
const modalCancelar = document.getElementById('modalCancelar');
const modalBorrar = document.getElementById('modalBorrar');

const tooltip = document.getElementById('tooltip');
const analisisContainer = document.getElementById('analisis-container');
const chartCanvas = document.getElementById('chartCanvas');

const INTERVALO = 0.5; // <-- NUEVO: Intervalo de tiempo por fila
let primerEncabezado = 'Minuto';
let columnas = ['Hombre']; // inicialmente
let acciones = []; // lista de acciones definidas: {nombre,duracion,color}
let accionActual = null;

let historyStack = [];
let redoStack = [];
const HISTORY_LIMIT = 60;

let clipboardBlock = null;
let dragState = null;

/* ---------- helpers ---------- */
function uid(){ return Date.now().toString(36) + Math.random().toString(36).slice(2,8) }
function saveHistory(){
Â  const snapshot = getState();
Â  historyStack.push(JSON.stringify(snapshot));
Â  if(historyStack.length>HISTORY_LIMIT) historyStack.shift();
Â  redoStack = []; // clear redo
Â  localStorage.setItem('autoSave', JSON.stringify(snapshot));
}
function undo(){ if(historyStack.length<=1) return; const cur = historyStack.pop(); redoStack.push(cur); const prev = JSON.parse(historyStack[historyStack.length-1]); loadState(prev, true) }
function redo(){ if(redoStack.length===0) return; const state = JSON.parse(redoStack.pop()); historyStack.push(JSON.stringify(state)); loadState(state, true) }

function getContrastingTextColor(hex){
Â  if(!hex) return 'white';
Â  if(hex.startsWith('#')) hex = hex.slice(1);
Â  const r=parseInt(hex.substr(0,2),16);
Â  const g=parseInt(hex.substr(2,2),16);
Â  const b=parseInt(hex.substr(4,2),16);
Â  const yiq = (r*299 + g*587 + b*114)/1000;
Â  return yiq>=128 ? 'black' : 'white';
}

/* ---------- tabla: generar y repoblar ---------- */
function generarTabla(isLoadingState = false){
Â  thead.innerHTML=''; tbody.innerHTML='';
Â  const minutos = parseFloat(minutosInput.value)||0;
Â  if(minutos<=0) return;
Â  const trHead = document.createElement('tr');
Â  trHead.innerHTML = `<th>${primerEncabezado}</th>` + columnas.map(c=>`<th>${c}</th>`).join('');
Â  thead.appendChild(trHead);
Â  // MODIFICADO: Bucle para usar el intervalo
Â  for(let i = INTERVALO; i <= minutos; i += INTERVALO){
Â  Â  const tr = document.createElement('tr');
Â  Â  tr.innerHTML = `<td>${i.toFixed(1)}</td>` + columnas.map(()=>`<td class="celda-inactiva"></td>`).join('');
Â  Â  tbody.appendChild(tr);
Â  }
Â  aplicarBordes();
Â  actualizarAnalisis();
Â  if (!isLoadingState) {
Â  Â  saveHistory();
Â  }
}

/* ---------- UI acciones (lista) ---------- */
function renderAcciones(){
Â  accionesDiv.innerHTML='';
Â  acciones.forEach((acc, idx)=>{
Â  Â  const wrapper = document.createElement('div');
Â  Â  wrapper.className = 'accion-wrapper';

Â  Â  const btn = document.createElement('button');
Â  Â  btn.className = 'btn-secondary';
Â  Â  btn.style.background = acc.color;
Â  Â  btn.style.border = '2px solid transparent';
Â  Â  btn.style.color = getContrastingTextColor(acc.color);
Â  Â  btn.textContent = `${acc.nombre} (${acc.duracion}m)`;
Â  Â  btn.onclick = ()=>{ accionActual = acc; Array.from(accionesDiv.querySelectorAll('.btn-secondary')).forEach(b=>b.style.borderColor='transparent'); btn.style.borderColor='#000' }
Â  Â  btn.ondblclick = ()=>{
Â  Â  Â  const nuevo = prompt('Editar nombre acciÃ³n (global):', acc.nombre);
Â  Â  Â  if(nuevo){ acc.nombre = nuevo; renderAcciones(); }
Â  Â  }
Â  Â Â 
Â  Â  const deleteBtn = document.createElement('div');
Â  Â  deleteBtn.className = 'btn-delete-action';
Â  Â  deleteBtn.textContent = 'Ã—';
Â  Â  deleteBtn.title = 'Borrar esta acciÃ³n';
Â  Â  deleteBtn.onclick = (e) => {
Â  Â  Â  e.stopPropagation();
Â  Â  Â  if (confirm(`Â¿Seguro que quieres borrar la acciÃ³n "${acc.nombre}"? Esto la eliminarÃ¡ de todo el diagrama.`)) {
Â  Â  Â  Â  document.querySelectorAll(`td[data-accion="${acc.nombre}"]`).forEach(td => {
Â  Â  Â  Â  Â  limpiarCelda(td);
Â  Â  Â  Â  });
Â  Â  Â  Â  acciones.splice(idx, 1);
Â  Â  Â  Â  renderAcciones();
Â  Â  Â  Â  saveHistory();
Â  Â  Â  }
Â  Â  };
Â  Â Â 
Â  Â  wrapper.appendChild(btn);
Â  Â  wrapper.appendChild(deleteBtn);
Â  Â  accionesDiv.appendChild(wrapper);
Â  });
}

/* ---------- pintar bloque (usa blockId) ---------- */
function pintarBloque(startRowIndex, colIndex, acc){
Â  const filas = Array.from(tbody.rows);
Â  // MODIFICADO: Calcular nÃºmero de filas segÃºn el intervalo
Â  const duracionEnFilas = Math.round((acc.duracion || 1) / INTERVALO);
Â  const middle = Math.floor((duracionEnFilas-1)/2);
Â  const blockId = uid();
Â  for(let i=0;i<duracionEnFilas;i++){
Â  Â  const r = startRowIndex + i;
Â  Â  if(r>=filas.length) break;
Â  Â  const td = filas[r].cells[colIndex];
Â  Â  td.className = '';
Â  Â  td.style.background = acc.color;
Â  Â  td.style.color = getContrastingTextColor(acc.color);

Â  Â  td.dataset.accion = acc.nombre;
Â  Â  td.dataset.blockId = blockId;
Â  Â  td.dataset.color = acc.color;
Â  Â  td.textContent = (i===middle) ? acc.nombre : '';
Â  Â  if(i===middle){
Â  Â  Â  td.classList.add('drag-handle');
Â  Â  }
Â  }
Â  aplicarBordes();
Â  actualizarAnalisis();
Â  saveHistory();
}

/* ---------- limpiar bloque por celda ---------- */
function limpiarCelda(celda){
Â  if(celda.dataset.blockId){
Â  Â  const bid = celda.dataset.blockId;
Â  Â  document.querySelectorAll(`td[data-block-id="${bid}"]`).forEach(c=>{
Â  Â  Â  c.className='celda-inactiva';
Â  Â  Â  c.style.background=''; c.style.color=''; c.textContent='';Â 
Â  Â  Â  c.removeAttribute('data-accion'); c.removeAttribute('data-block-id'); c.removeAttribute('data-color');Â 
Â  Â  Â  c.classList.remove('drag-handle');
Â  Â  });
Â  } else {
Â  Â  celda.className='celda-inactiva';
Â  Â  celda.style.background=''; celda.style.color=''; celda.textContent='';Â 
Â  Â  celda.removeAttribute('data-accion');
Â  }
Â  aplicarBordes();
Â  actualizarAnalisis();
}

/* ---------- aplicar bordes externos Ãºnicos por bloque ---------- */
function aplicarBordes(){
Â  const rows = Array.from(tbody.rows);
Â  rows.forEach(r=>{
Â  Â  Array.from(r.cells).forEach(td=>{
Â  Â  Â  td.style.border = `1px solid ${getComputedStyle(document.documentElement).getPropertyValue('--border') || '#dee2e6'}`;
Â  Â  });
Â  });

Â  const bloques = {};
Â  document.querySelectorAll('td[data-block-id]').forEach(td=>{
Â  Â  const id = td.dataset.blockId;
Â  Â  if(!bloques[id]) bloques[id] = [];
Â  Â  bloques[id].push(td);
Â  });

Â  Object.values(bloques).forEach(celdas=>{
Â  Â  celdas.sort((a,b)=>a.parentElement.rowIndex - b.parentElement.rowIndex);
Â  Â  const first = celdas[0], last = celdas[celdas.length-1];
Â  Â  celdas.forEach(td=>{
Â  Â  Â  td.style.borderLeft = '2px solid black';
Â  Â  Â  td.style.borderRight = '2px solid black';
Â  Â  Â  td.style.borderTop = 'none';
Â  Â  Â  td.style.borderBottom = 'none';
Â  Â  });
Â  Â  first.style.borderTop = '2px solid black';
Â  Â  last.style.borderBottom = '2px solid black';
Â  });
}

/* ---------- eventos tabla: click, hover, drag ---------- */
tabla.addEventListener('click', (ev)=>{
Â  const td = ev.target;
Â  if(td.tagName !== 'TD' || td.cellIndex === 0) return;

Â  if(td.dataset.blockId){
Â  Â  openModalForBlock(td.dataset.blockId);
Â  Â  return;
Â  }

Â  if(!accionActual){ alert('Selecciona una acciÃ³n en "Acciones disponibles"'); return; }

Â  const filaIndex = Array.from(tbody.rows).indexOf(td.parentElement);
Â  if(filaIndex<0) return;
Â  pintarBloque(filaIndex, td.cellIndex, accionActual);
});

tabla.addEventListener('mousemove', (e)=>{
Â  const el = e.target;
Â  if(el.tagName==='TD' && el.dataset.accion){
Â  Â  tooltip.style.left = (e.pageX+12)+'px';
Â  Â  tooltip.style.top = (e.pageY+12)+'px';
    const fila = (el.parentElement.rowIndex + 1) * INTERVALO;
Â  Â  tooltip.innerHTML = `<b>${el.dataset.accion}</b><br>Inicia en min: ${fila.toFixed(1)}`;
Â  Â  tooltip.style.opacity = 1;
Â  } else {
Â  Â  tooltip.style.opacity = 0;
Â  }
});

tabla.addEventListener('mousedown', (e)=>{
Â  const td = e.target;
Â  if(td.tagName==='TD' && td.classList.contains('drag-handle') && td.dataset.blockId){
Â  Â  dragState = {Â 
Â  Â  Â  bid: td.dataset.blockId,Â 
Â  Â  Â  colIndex: td.cellIndex,Â 
Â  Â  Â  startY: e.clientY,
Â  Â  Â  hasMoved: false
Â  Â  };
Â  Â  document.body.style.cursor = 'grabbing';
Â  }
});

document.addEventListener('mousemove', (e) => {
Â  if (dragState) {
Â  Â  if (Math.abs(e.clientY - dragState.startY) > 5) {
Â  Â  Â  dragState.hasMoved = true;
Â  Â  }
Â  }
});

document.addEventListener('mouseup', (e) => {
Â  if (dragState && dragState.hasMoved) {
Â  Â  const targetCell = document.elementFromPoint(e.clientX, e.clientY);

Â  Â  if (targetCell && targetCell.tagName === 'TD' && targetCell.parentElement.parentElement.tagName === 'TBODY' && targetCell.cellIndex > 0) {
Â  Â  Â  const targetRowIndex = Array.from(tbody.rows).indexOf(targetCell.parentElement);
Â  Â  Â  const targetColIndex = targetCell.cellIndex;
Â  Â  Â  const { bid } = dragState;
Â  Â  Â  const blockCels = Array.from(document.querySelectorAll(`td[data-block-id="${bid}"]`));

Â  Â  Â  if (blockCels.length > 0) {
Â  Â  Â  Â  const aName = blockCels[0].dataset.accion;
Â  Â  Â  Â  const actionObj = acciones.find(a => a.nombre === aName) || {
Â  Â  Â  Â  Â  nombre: aName,
Â  Â  Â  Â  Â  duracion: blockCels.length * INTERVALO, // MODIFICADO: Convertir filas a minutos
Â  Â  Â  Â  Â  color: blockCels[0].dataset.color || blockCels[0].style.backgroundColor,
Â  Â  Â  Â  };

Â  Â  Â  Â  blockCels.forEach(c => limpiarCelda(c));
Â  Â  Â  Â  pintarBloque(targetRowIndex, targetColIndex, actionObj);
Â  Â  Â  }
Â  Â  }
Â  }
Â  dragState = null;
Â  document.body.style.cursor = '';
});

thead.addEventListener('click', (e) => {
Â  const th = e.target;
Â  if (th.tagName !== 'TH') return;

Â  const nombreActual = th.textContent;
Â  const nuevoNombre = prompt('Editar nombre de la columna:', nombreActual);

Â  if (nuevoNombre && nuevoNombre.trim() !== '') {
Â  Â  const nombreRecortado = nuevoNombre.trim();
Â  Â  th.textContent = nombreRecortado;

Â  Â  if (th.cellIndex === 0) {
Â  Â  Â  primerEncabezado = nombreRecortado;
Â  Â  } else {
Â  Â  Â  columnas[th.cellIndex - 1] = nombreRecortado;
Â  Â  Â  actualizarAnalisis();
Â  Â  }
Â  Â  saveHistory();
Â  }
});

/* ---------- modal operations ---------- */
let editingBlockId = null;
function openModalForBlock(bid){
Â  editingBlockId = bid;
Â  const cells = Array.from(document.querySelectorAll(`td[data-block-id="${bid}"]`));
Â  if(!cells.length) return;
Â  const midCell = cells[Math.floor(cells.length/2)];
Â  modalNombre.value = midCell.dataset.accion || '';
Â  modalColor.value = midCell.dataset.color || '#0d6efd';
Â  // MODIFICADO: Convertir nÃºmero de filas a minutos para el input
Â  modalDuracion.value = cells.length * INTERVALO;
Â  modal.style.display = 'flex';
Â  modalNombre.focus();
}
modalCancelar.onclick = ()=>{ modal.style.display='none'; editingBlockId=null }
modalGuardar.onclick = ()=>{
Â  const nuevoNombre = modalNombre.value.trim();
Â  if(!editingBlockId){ modal.style.display='none'; return; }
Â Â 
Â  const cells = Array.from(document.querySelectorAll(`td[data-block-id="${editingBlockId}"]`));
Â  if(!cells.length){ modal.style.display='none'; editingBlockId=null; return; }
Â Â 
  // MODIFICADO: Leer duraciÃ³n en minutos y convertir de filas a minutos si estÃ¡ vacÃ­o
Â  const nuevaDuracion = parseFloat(modalDuracion.value) || (cells.length * INTERVALO);
Â  const nuevoColor = modalColor.value;
Â Â 
Â  const startIndex = Array.from(tbody.rows).indexOf(cells[0].parentElement);
Â  const colIndex = cells[0].cellIndex;
Â Â 
Â  cells.forEach(c => limpiarCelda(c));
Â Â 
Â  const actionName = nuevoNombre || 'Accion';
Â  const actionObj = acciones.find(a=>a.nombre===actionName);
Â Â 
Â  let accObj;
Â  if(actionObj){
Â  Â  actionObj.color = nuevoColor; actionObj.duracion = nuevaDuracion;
Â  Â  accObj = actionObj;
Â  } else {
Â  Â  accObj = {nombre:actionName, duracion:nuevaDuracion, color:nuevoColor};
Â  Â  acciones.push(accObj);
Â  Â  renderAcciones();
Â  }

Â  pintarBloque(startIndex, colIndex, accObj);
Â  modal.style.display='none';
Â  editingBlockId=null;
};
modalBorrar.onclick = ()=>{
Â  if(!editingBlockId || !confirm('Â¿Borrar este bloque?')) return;
Â Â 
Â  document.querySelectorAll(`td[data-block-id="${editingBlockId}"]`).forEach(c => limpiarCelda(c));
Â  modal.style.display='none';
Â  editingBlockId=null;
Â  saveHistory();
}

/* ---------- crear acciones globales ---------- */
btnCrearAccion.onclick = ()=>{
Â  const name = inputNombreAccion.value.trim();
Â  if(!name){ alert('Ingresa un nombre para la acciÃ³n.'); return; }
  // MODIFICADO: Leer flotante
Â  const dur = parseFloat(inputDuracionAccion.value) || 1;
Â  const color = inputColorAccion.value || '#0d6efd';
Â  acciones.push({nombre:name,duracion:dur,color});
Â  renderAcciones();
Â  inputNombreAccion.value=''; inputDuracionAccion.value='1';
Â  saveHistory();
}

/* ---------- agregar maquina ---------- */
btnAgregarMaquina.onclick = ()=>{
Â  const nombreNuevaMaquina = `M${columnas.length}`;
Â  columnas.push(nombreNuevaMaquina);

Â  const th = document.createElement('th');
Â  th.textContent = nombreNuevaMaquina;
Â  thead.querySelector('tr').appendChild(th);

Â  tbody.querySelectorAll('tr').forEach(fila => {
Â  Â  const td = document.createElement('td');
Â  Â  td.className = 'celda-inactiva';
Â  Â  fila.appendChild(td);
Â  });

Â  actualizarAnalisis();
Â  saveHistory();
}

/* ---------- guardar / cargar JSON ---------- */
btnGuardar.onclick = ()=>{
Â  const state = getState();
Â  const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state,null,2));
Â  const a = document.createElement('a');
Â  a.href = dataStr; a.download = 'diagrama.json'; document.body.appendChild(a); a.click(); a.remove();
}
btnCargar.onclick = ()=> fileInput.click();
fileInput.onchange = e=>{
Â  const f = e.target.files[0];
Â  if(!f) return;
Â  const reader = new FileReader();
Â  reader.onload = ()=> {
Â  Â  try{
Â  Â  Â  const state = JSON.parse(reader.result);
Â  Â  Â  loadState(state);
Â  Â  Â  saveHistory();
Â  Â  }catch(err){ alert('Error al cargar el archivo JSON.'); console.error(err) }
Â  };
Â  reader.readAsText(f);
}

/* ---------- export PNG (Fiel a la vista) ---------- */
btnExportPNG.onclick = () => {
Â  const tablaParaExportar = document.getElementById('tabla-actividades');
Â  tablaParaExportar.style.outline = '2px solid var(--accent)';
Â Â 
Â  html2canvas(tablaParaExportar, {
Â  Â  useCORS: true, logging: false,
Â  Â  onclone: (doc) => {
Â  Â  Â  doc.getElementById('tabla-actividades').style.transform = '';
Â  Â  }
Â  }).then(canvas => {
Â  Â  const a = document.createElement('a');
Â  Â  a.href = canvas.toDataURL('image/png');
Â  Â  a.download = 'diagrama-hombre-maquina.png';
Â  Â  document.body.appendChild(a);
Â  Â  a.click();
Â  Â  document.body.removeChild(a);
Â  Â  tablaParaExportar.style.outline = 'none';
Â  });
};

/* ---------- copy / paste / split ---------- */
btnCopy.onclick = ()=>{
Â  if(lastClickedBlockId){
Â  Â  clipboardBlock = captureBlock(lastClickedBlockId);
Â  Â  alert('Bloque copiado.');
Â  } else alert('Haz click en un bloque para copiarlo.');
};
btnPaste.onclick = ()=>{
Â  if(!clipboardBlock) return alert('No hay nada en el portapapeles.');
Â  const target = lastSelectedCell || tbody.rows[0].cells[1];
Â  if(!target) return;
Â  const filaIndex = Array.from(tbody.rows).indexOf(target.parentElement);
Â  pintarBlockFromData(filaIndex, target.cellIndex, clipboardBlock);
Â  saveHistory();
};
btnSplit.onclick = ()=>{
Â  if(!lastClickedBlockId) return alert('Haz click en un bloque para dividirlo.');
Â  const bid = lastClickedBlockId;
Â  const cells = Array.from(document.querySelectorAll(`td[data-block-id="${bid}"]`));
Â  if(cells.length<=1) return alert('El bloque es demasiado pequeÃ±o para ser dividido.');
Â  const midIndex = Math.floor(cells.length/2);
Â  const first = cells.slice(0,midIndex);
Â  const second = cells.slice(midIndex);
Â  const id1 = uid(), id2 = uid();
Â  first.forEach(c=>{ c.dataset.blockId = id1; });
Â  second.forEach(c=>{ c.dataset.blockId = id2; });
Â  aplicarBordes();
Â  saveHistory();
}

/* helper capture block */
function captureBlock(bid){
Â  const cells = Array.from(document.querySelectorAll(`td[data-block-id="${bid}"]`));
Â  if(!cells.length) return null;
Â  return {
Â  Â  nombre: cells[0].dataset.accion,
Â  Â  color: cells[0].dataset.color || cells[0].style.backgroundColor,
Â  Â  duracion: cells.length * INTERVALO // MODIFICADO: Convertir filas a minutos
Â  };
}
function pintarBlockFromData(startRow, colIndex, data){
Â  const filas = Array.from(tbody.rows);
Â  const dur_en_filas = Math.round((data.duracion || 1) / INTERVALO); // MODIFICADO
Â  const blockId = uid();
Â  for(let i=0;i<dur_en_filas;i++){
Â  Â  const r = startRow + i;
Â  Â  if(r>=filas.length) break;
Â  Â  const td = filas[r].cells[colIndex];
Â  Â  td.className='';Â 
Â  Â  td.style.background = data.color;Â 
Â  Â  td.style.color = getContrastingTextColor(data.color);
Â  Â  td.dataset.accion = data.nombre;
Â  Â  td.dataset.blockId = blockId;
Â  Â  td.dataset.color = data.color;
Â  Â  td.textContent = (i===Math.floor((dur_en_filas-1)/2))?data.nombre:'';
Â  }
Â  aplicarBordes();
Â  actualizarAnalisis();
}

/* ---------- undo / redo ---------- */
btnUndo.onclick = ()=>undo();
btnRedo.onclick = ()=>redo();

/* ---------- zoom control ---------- */
zoomRange.oninput = ()=> {
Â  tabla.style.transform = `scale(${zoomRange.value/100})`;
}

/* ---------- share link ---------- */
btnShare.onclick = () => {
Â  const state = getState();
Â  const jsonString = JSON.stringify(state);
Â  const compressed = LZString.compressToEncodedURIComponent(jsonString);
Â  const url = location.origin + location.pathname + '#s=' + compressed;
Â  prompt('Copia este link corto y compÃ¡rtelo:', url);
}

/* ---------- autosave restore / clear ---------- */
btnRestore.onclick = ()=>{
Â  const saved = localStorage.getItem('autoSave');
Â  if(!saved) return alert('No hay datos guardados para restaurar.');
Â  try{ const state = JSON.parse(saved); loadState(state); saveHistory(); }catch(e){ alert('No se pudo restaurar.'); }
};
btnClear.onclick = ()=>{ if(confirm('Â¿Seguro que quieres borrar todo el diagrama?')){ primerEncabezado = 'Minuto'; columnas=['Hombre']; acciones=[]; generarTabla(); renderAcciones(); localStorage.removeItem('autoSave'); saveHistory(); } }

/* ---------- state helpers ---------- */
function getState(){
Â  const tablaData = Array.from(tbody.rows).map(tr=> Array.from(tr.cells).slice(1).map(td=>{
Â  Â  return td.dataset.blockId ? {blockId: td.dataset.blockId, accion: td.dataset.accion, color: td.dataset.color} : null;
Â  }));
Â  return { primerEncabezado, columnas, acciones, minutos: parseFloat(minutosInput.value)||0, tablaData };
}

function loadState(state, skipHistory=false){
Â  if(!state) return;
Â  primerEncabezado = state.primerEncabezado || 'Minuto';
Â  columnas = state.columnas || ['Hombre'];
Â  acciones = state.acciones || [];
Â  minutosInput.value = state.minutos || 60;
Â Â 
Â  generarTabla(true);Â 

Â  if(state.tablaData){
Â  Â  const rows = Array.from(tbody.rows);
Â  Â  state.tablaData.forEach((filaData, rIdx)=>{
Â  Â  Â  if (filaData) {
Â  Â  Â  Â  filaData.forEach((cellData, cIdx)=>{
Â  Â  Â  Â  Â  if(cellData && rows[rIdx] && rows[rIdx].cells[cIdx+1]){
Â  Â  Â  Â  Â  Â  const td = rows[rIdx].cells[cIdx+1];
Â  Â  Â  Â  Â  Â  td.className='';Â 
Â  Â  Â  Â  Â  Â  td.style.background = cellData.color || '#fff';Â 
Â  Â  Â  Â  Â  Â  td.style.color = getContrastingTextColor(cellData.color||'#fff');
Â  Â  Â  Â  Â  Â  td.dataset.accion = cellData.accion;
Â  Â  Â  Â  Â  Â  td.dataset.blockId = cellData.blockId || uid();
Â  Â  Â  Â  Â  Â  td.dataset.color = cellData.color || '';
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  }
Â  Â  });

Â  Â  const groups = {};
Â  Â  tbody.querySelectorAll('td[data-block-id]').forEach(td=>{
Â  Â  Â  const id = td.dataset.blockId;
Â  Â  Â  if(!groups[id]) groups[id]=[];
Â  Â  Â  groups[id].push(td);
Â  Â  });
Â  Â  Object.values(groups).forEach(g=>{
Â  Â  Â  g.sort((a,b)=>a.parentElement.rowIndex - b.parentElement.rowIndex);
Â  Â  Â  const mid = Math.floor((g.length-1)/2);
Â  Â  Â  g.forEach((c,i)=> {
Â  Â  Â  Â  c.textContent = (i===mid)? c.dataset.accion : '';
Â  Â  Â  Â  if (i===mid) c.classList.add('drag-handle');
Â  Â  Â  });
Â  Â  });
Â  }
Â  renderAcciones();
Â  aplicarBordes();
Â  actualizarAnalisis();
Â  if(!skipHistory) saveHistory();
}

/* ---------- analysis and chart ---------- */
function actualizarAnalisis(){
Â  analisisContainer.innerHTML = '';
Â  const minutos = parseFloat(minutosInput.value)||0;
Â  if (minutos === 0) return;
Â Â 
Â  columnas.forEach((col, idxCol)=>{
Â  Â  let used = 0; // nÃºmero de celdas
Â  Â  if(tbody.rows.length > 0 && tbody.rows[0].cells.length > idxCol + 1) {
Â  Â  Â  for(let r=0;r<tbody.rows.length;r++){
Â  Â  Â  Â  const td = tbody.rows[r].cells[idxCol+1];
Â  Â  Â  Â  if(td && td.dataset.blockId) used++;
Â  Â  Â  }
Â  Â  }
    // MODIFICADO: CÃ¡lculos basados en el intervalo
Â  Â  const tiempoActivo = used * INTERVALO;
Â  Â  const tiempoOcioso = minutos - tiempoActivo;
    const porcentajeActivo = (tiempoActivo / minutos) * 100 || 0;
Â  Â  const p = document.createElement('p');
Â  Â  p.innerHTML = `<b>${col}:</b> ${porcentajeActivo.toFixed(1)}% activo (${tiempoActivo.toFixed(1)} min) â€” ocioso ${tiempoOcioso.toFixed(1)} min`;
Â  Â  analisisContainer.appendChild(p);
Â  });

Â  const counts = {};
Â  tbody.querySelectorAll('td[data-accion]').forEach(td=>{
Â  Â  const name = td.dataset.accion || 'SinNombre';
Â  Â  counts[name] = (counts[name]||0) + 1;
Â  });
Â  const labels = Object.keys(counts);
Â  const data = labels.map(l=>counts[l]); // data es nÃºmero de celdas
Â  drawPieChart(chartCanvas, labels, data);
}

function drawPieChart(canvas, labels, data){
Â  const ctx = canvas.getContext('2d');
Â  ctx.clearRect(0,0,canvas.width,canvas.height);
Â  const total = data.reduce((a,b)=>a+b,0);
Â  if(total===0){
Â  Â  ctx.fillStyle='#666'; ctx.font='14px Arial'; ctx.fillText('No hay datos', 10, 20); return;
Â  }
Â  let start=0;
Â  const cx = canvas.width/2;
Â  const cy = canvas.height/2;
Â  const radius = Math.min(cx,cy) - 10;
Â  labels.forEach((lab,i)=>{
Â  Â  const val = data[i];
Â  Â  const slice = val/total * Math.PI*2;
Â  Â  ctx.beginPath();
Â  Â  ctx.moveTo(cx,cy);
Â  Â  ctx.arc(cx,cy, radius, start, start+slice);
Â  Â  ctx.closePath();
Â  Â  ctx.fillStyle = stringToColor(lab);
Â  Â  ctx.fill();
Â  Â  start += slice;
Â  });
Â  // legend
Â  ctx.font='12px Arial';
Â  labels.forEach((lab,i)=>{
Â  Â  ctx.fillStyle = stringToColor(lab);
Â  Â  ctx.fillRect(8, 8 + i*16 + 6, 10, 10);
Â  Â  ctx.fillStyle = '#000';
    // MODIFICADO: Convertir celdas a minutos para la leyenda
Â  Â  ctx.fillText(`${lab} (${(data[i] * INTERVALO).toFixed(1)} min)`, 24, 16 + i*16);
Â  });
}

function stringToColor(str){
Â  let h = 0; for(let i=0;i<str.length;i++) h = str.charCodeAt(i) + ((h<<5)-h);
Â  const c = (h & 0x00FFFFFF).toString(16).toUpperCase();
Â  return '#'+ ('00000'.substring(0,6 - c.length) + c);
}

/* ---------- keyboard shortcuts ---------- */
let lastClickedBlockId = null;
let lastSelectedCell = null;
document.addEventListener('keydown', (e)=>{
Â  const targetTagName = e.target.tagName.toLowerCase();
Â  if (targetTagName === 'input' || targetTagName === 'select' || targetTagName === 'textarea') {
Â  Â  return;
Â  }

Â  if(e.ctrlKey && e.key==='z'){ e.preventDefault(); undo(); }
Â  if(e.ctrlKey && e.key==='y'){ e.preventDefault(); redo(); }
Â  if(e.ctrlKey && e.key==='c'){ e.preventDefault(); if(lastClickedBlockId) clipboardBlock = captureBlock(lastClickedBlockId); }
Â  if(e.ctrlKey && e.key==='v'){ e.preventDefault(); btnPaste.click(); }
Â  if(e.key==='Delete' || e.key === 'Backspace'){ if(lastClickedBlockId){ document.querySelectorAll(`td[data-block-id="${lastClickedBlockId}"]`).forEach(c=>limpiarCelda(c)); saveHistory(); } }
});

// track last clicked block and selected cell
tabla.addEventListener('click', (e)=>{
Â  const td = e.target;
Â  if(td.tagName==='TD'){
Â  Â  lastSelectedCell = td;
Â  Â  lastClickedBlockId = td.dataset.blockId || null;
Â  }
});

/* ---------- initial load & hash support ---------- */
function init() {
Â  btnGenerar.onclick = generarTabla;

Â  try {
Â  Â  if (location.hash.startsWith('#s=')) { // Chequea el nuevo formato comprimido
Â  Â  Â  const compressed = location.hash.replace('#s=', '');
Â  Â  Â  const jsonString = LZString.decompressFromEncodedURIComponent(compressed);
Â  Â  Â  const state = JSON.parse(jsonString);
Â  Â  Â  loadState(state);
Â  Â  Â  return;
Â  Â  } else if (location.hash.startsWith('#state=')) { // Mantiene compatibilidad con el formato antiguo
Â  Â  Â  const json = decodeURIComponent(location.hash.replace('#state=', ''));
Â  Â  Â  const state = JSON.parse(json);
Â  Â  Â  loadState(state);
Â  Â  Â  return;
Â  Â  }
Â  } catch (e) {
Â  Â  console.warn('No se pudo cargar el estado desde el hash.', e);
Â  }

Â  // Carga por defecto o desde el guardado local
Â  acciones = [
Â  Â  { nombre: 'Trabajo', duracion: 5, color: '#0d6efd' },
Â  Â  { nombre: 'Espera', duracion: 3, color: '#ffc107' }
Â  ];
Â  renderAcciones();

Â  const saved = localStorage.getItem('autoSave');
Â  if (saved) {
Â  Â  try { const s = JSON.parse(saved); loadState(s, true); } catch (e) { generarTabla(); }
Â  } else {
Â  Â  generarTabla();
Â  }
Â  saveHistory();
}
init();

window.addEventListener('beforeunload', ()=>{ localStorage.setItem('autoSave', JSON.stringify(getState())); });

</script>
</body>
</html>
