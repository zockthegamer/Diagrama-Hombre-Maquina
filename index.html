<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagrama Bimanual Mejorado</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
            background-color: #f4f4f9;
        }
        .container {
            display: flex;
            gap: 30px;
        }
        .controls {
            padding: 15px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            height: fit-content;
        }
        .controls h3 {
            margin-top: 0;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
        }
        .control-group {
            margin-bottom: 15px;
        }
        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 0.9em;
        }
        .control-group input, .control-group select {
            width: 100%;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
            box-sizing: border-box; /* Importante para que el padding no afecte el ancho */
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
            font-size: 1em;
            margin-top: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        #btn-export {
            background-color: #28a745;
        }
        #btn-export:hover {
            background-color: #218838;
        }
        table {
            border-collapse: collapse;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            background-color: #fff;
        }
        th, td {
            border: 1px solid #ccc;
            width: 50px; /* Ancho fijo para las celdas de tiempo */
            height: 40px;
            text-align: center;
            padding: 0;
            position: relative; /* Para posicionamiento del texto */
        }
        th {
            background-color: #e9ecef;
        }
        td.header-cell {
            background-color: #f8f9fa;
            font-weight: bold;
            width: 100px; /* Ancho para las cabeceras de fila */
        }
        td:not(.header-cell) {
            cursor: pointer;
        }
        td:not(.header-cell):hover {
            background-color: #e0e0e0;
        }
        .cell-text {
            color: white;
            font-weight: bold;
            font-size: 0.8em;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
            /* Para evitar que el texto se pueda seleccionar */
            user-select: none;
            -moz-user-select: none;
            -webkit-user-select: none;
            -ms-user-select: none;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="controls">
        <h3>Control de Acciones</h3>
        <div class="control-group">
            <label for="action-name">Nombre de la Acción:</label>
            <input type="text" id="action-name" value="Tomar pieza">
        </div>
        <div class="control-group">
            <label for="duration">Duración (min):</label>
            <input type="number" id="duration" value="3" min="1">
        </div>
        <div class="control-group">
            <label for="color">Color:</label>
            <input type="color" id="color" value="#4CAF50">
        </div>
        <div class="control-group">
            <label for="hand-select">Mano:</label>
            <select id="hand-select">
                <option value="left-hand">Mano Izquierda</option>
                <option value="right-hand">Mano Derecha</option>
            </select>
        </div>
        <button id="btn-export">Exportar como Imagen</button>
    </div>

    <div id="diagram-container">
        <table id="gantt-table">
            <thead>
                <tr>
                    <th>Mano / Tiempo</th>
                    </tr>
            </thead>
            <tbody>
                <tr id="left-hand">
                    <td class="header-cell">Mano Izquierda</td>
                    </tr>
                <tr id="right-hand">
                    <td class="header-cell">Mano Derecha</td>
                    </tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const table = document.getElementById('gantt-table');
        const totalMinutes = 30; // Total de minutos en la tabla

        // --- Generación de la Tabla Dinámica ---
        const headerRow = table.querySelector('thead tr');
        const leftHandRow = document.getElementById('left-hand');
        const rightHandRow = document.getElementById('right-hand');

        for (let i = 1; i <= totalMinutes; i++) {
            const th = document.createElement('th');
            th.textContent = i;
            headerRow.appendChild(th);

            const tdLeft = document.createElement('td');
            tdLeft.dataset.time = i;
            tdLeft.dataset.hand = 'left-hand';
            leftHandRow.appendChild(tdLeft);

            const tdRight = document.createElement('td');
            tdRight.dataset.time = i;
            tdRight.dataset.hand = 'right-hand';
            rightHandRow.appendChild(tdRight);
        }

        // --- Lógica para pintar y añadir texto ---
        table.addEventListener('click', function(e) {
            if (e.target.tagName === 'TD' && e.target.dataset.time) {
                const actionName = document.getElementById('action-name').value;
                const duration = parseInt(document.getElementById('duration').value, 10);
                const color = document.getElementById('color').value;
                const selectedHand = document.getElementById('hand-select').value;
                const startTime = parseInt(e.target.dataset.time, 10);
                const clickedHand = e.target.dataset.hand;

                // Aplicar solo a la mano seleccionada en el panel de control
                if (clickedHand === selectedHand) {
                   paintAction(clickedHand, startTime, duration, actionName, color);
                }
            }
        });
        
        function paintAction(hand, start, duration, name, color) {
            const row = document.getElementById(hand);
            if (!row) return;

            const endTime = start + duration - 1;

            // 1. Limpiar celdas que serán sobreescritas
            for (let i = start; i <= endTime && i <= totalMinutes; i++) {
                const cell = row.querySelector(`td[data-time='${i}']`);
                if (cell) {
                    cell.style.backgroundColor = ''; // Quita el color
                    cell.innerHTML = ''; // Limpia cualquier texto anterior
                }
            }

            // 2. Pintar las nuevas celdas
            for (let i = start; i <= endTime && i <= totalMinutes; i++) {
                const cell = row.querySelector(`td[data-time='${i}']`);
                if (cell) {
                    cell.style.backgroundColor = color;
                }
            }
            
            // 3. Poner el nombre en la casilla del medio
            const middleTime = start + Math.floor(duration / 2);
            if (middleTime <= totalMinutes) {
                const middleCell = row.querySelector(`td[data-time='${middleTime}']`);
                if (middleCell) {
                    // Usamos un div para un mejor control del estilo si fuera necesario
                    middleCell.innerHTML = `<div class="cell-text">${name}</div>`;
                }
            }
        }

        // --- Lógica para exportar la imagen ---
        const exportButton = document.getElementById('btn-export');
        exportButton.addEventListener('click', function() {
            const diagramContainer = document.getElementById('diagram-container');
            // Usamos la librería html2canvas
            html2canvas(diagramContainer).then(canvas => {
                // Crear un enlace temporal para la descarga
                const link = document.createElement('a');
                link.download = 'diagrama-bimanual.png';
                link.href = canvas.toDataURL('image/png');
                link.click(); // Simula un clic para iniciar la descarga
            });
        });
    });
</script>

</body>
</html>
