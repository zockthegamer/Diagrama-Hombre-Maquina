<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Diagrama Hombre-Máquina Avanzado</title>
  <style>
    :root {
      --borde-color: #dee2e6;
      --fondo-gris: #f8f9fa;
      --azul-principal: #0d6efd;
      --rojo-peligro: #dc3545;
      --texto-claro: #fff;
      --gris-oscuro: #6c757d;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background-color: var(--fondo-gris);
      color: #212529;
      margin: 0;
      padding: 20px;
      display: flex;
      justify-content: center;
    }
    main {
      width: 100%;
      max-width: 950px;
      background-color: #fff;
      padding: 25px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h2, h3 {
      border-bottom: 2px solid var(--borde-color);
      padding-bottom: 10px;
      margin-top: 0;
    }

    .seccion { margin-bottom: 25px; padding: 20px; border: 1px solid var(--borde-color); border-radius: 5px; }
    .control-grupo, .accion-grupo { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-bottom: 15px; }
    input[type="number"], input[type="text"], input[type="color"] { padding: 8px 12px; border: 1px solid var(--borde-color); border-radius: 4px; font-size: 1rem; }
    input#duracionAccion { width: 80px; }
    button { padding: 8px 15px; border: none; border-radius: 4px; color: var(--texto-claro); font-weight: bold; cursor: pointer; transition: opacity 0.2s; }
    button:hover { opacity: 0.85; }
    .btn-principal { background-color: var(--azul-principal); }
    .btn-rojo { background-color: var(--rojo-peligro); }
    .btn-secundario { background-color: var(--gris-oscuro); }
    #acciones-disponibles { margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap; }

    .tabla-contenedor { max-height: 600px; overflow-y: auto; border: 1px solid var(--borde-color); }
    table { width: 100%; border-collapse: collapse; text-align: center; }
    th, td { border: 1px solid var(--borde-color); padding: 5px; min-width: 80px; height: 25px; font-size: 0.9rem; }
    td[data-accion] { font-weight: bold; font-size: 0.8em; vertical-align: middle; cursor: pointer; }
    thead th { position: sticky; top: 0; background-color: #e9ecef; }
    tbody td:first-child { font-weight: bold; background-color: var(--fondo-gris); }
    .celda-inactiva {
      background-image: repeating-linear-gradient(45deg, rgba(220, 53, 69, 0.08), rgba(220, 53, 69, 0.08) 8px, transparent 8px, transparent 16px);
    }

    /* Modal para renombrar acción */
    #modalEditar {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.5);
      z-index: 999;
    }
    #modalContenido {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
      width: 90%;
      max-width: 420px;
    }
    #modalContenido input {
      padding: 8px;
      font-size: 1rem;
      margin-bottom: 10px;
      width: 100%;
      box-sizing: border-box;
      border: 1px solid var(--borde-color);
      border-radius: 6px;
    }

    #tooltip {
      position: absolute;
      visibility: hidden;
      background-color: #333;
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 5px 8px;
      z-index: 10;
      opacity: 0;
      transition: opacity 0.15s;
      font-size: 0.85rem;
    }
  </style>
</head>
<body>
  <div id="tooltip"></div>
  <main>
    <h2>Diagrama Hombre-Máquina Avanzado</h2>

    <div class="seccion">
      <h3>Configuración</h3>
      <div class="control-grupo">
        <label for="minutos">Minutos Totales:</label>
        <input type="number" id="minutos" value="60">
        <button id="btnGenerar" class="btn-principal">Generar / Reiniciar</button>
        <button id="btnAgregarMaquina" class="btn-principal">+ Máquina</button>
      </div>
      <div class="control-grupo">
        <button id="btnGuardar" class="btn-secundario">💾 Guardar Diagrama</button>
        <button id="btnCargar" class="btn-secundario">📂 Cargar Diagrama</button>
        <input type="file" id="inputCargar" accept=".json" style="display: none;">
      </div>
    </div>
    
    <div class="seccion">
      <h3>Acciones</h3>
      <div class="accion-grupo">
        <input type="text" id="nombreAccion" placeholder="Nombre de acción">
        <input type="number" id="duracionAccion" placeholder="Min" min="1" value="1" title="Duración en minutos">
        <input type="color" id="colorAccion" value="#4caf50">
        <button id="btnCrearAccion" class="btn-principal">Crear Acción</button>
        <button id="btnModoEliminar" class="btn-rojo">Activar Modo Eliminar</button>
      </div>
      <div id="acciones-disponibles"></div>
    </div>

    <div class="seccion">
      <h3>Análisis de Actividad</h3>
      <div id="analisis-container"><p>Genera la tabla para ver el análisis.</p></div>
    </div>

    <div class="tabla-contenedor">
      <table id="tabla-actividades">
        <thead></thead>
        <tbody></tbody>
      </table>
    </div>
  </main>

  <!-- Modal -->
  <div id="modalEditar">
    <div id="modalContenido">
      <h3>Editar nombre de la acción</h3>
      <input type="text" id="inputNuevoNombre"/>
      <div style="margin-top:12px;">
        <button id="btnGuardarNombre" class="btn-principal">Guardar</button>
        <button id="btnCancelarNombre" class="btn-rojo">Cancelar</button>
      </div>
    </div>
  </div>

  <script>
    const tabla = document.getElementById('tabla-actividades');
    const thead = tabla.querySelector('thead');
    const tbody = tabla.querySelector('tbody');
    const inputMinutos = document.getElementById('minutos');
    const btnGenerar = document.getElementById('btnGenerar');
    const btnAgregarMaquina = document.getElementById('btnAgregarMaquina');
    const btnCrearAccion = document.getElementById('btnCrearAccion');
    const inputNombreAccion = document.getElementById('nombreAccion');
    const inputDuracionAccion = document.getElementById('duracionAccion');
    const inputColorAccion = document.getElementById('colorAccion');
    const divAcciones = document.getElementById('acciones-disponibles');
    const btnModoEliminar = document.getElementById('btnModoEliminar');
    const divAnalisis = document.getElementById('analisis-container');

    const modalEditar = document.getElementById('modalEditar');
    const inputNuevoNombre = document.getElementById('inputNuevoNombre');
    const btnGuardarNombre = document.getElementById('btnGuardarNombre');
    const btnCancelarNombre = document.getElementById('btnCancelarNombre');

    let columnas = ['Hombre'];
    let acciones = [];
    let accionActual = null;
    let modoEliminar = false;
    let nombreAccionEditando = null;
    let blockIdEditando = null;

    // Generar tabla
    function generarTabla() {
      thead.innerHTML = '';
      tbody.innerHTML = '';
      const minutosTotales = parseInt(inputMinutos.value) || 0;
      if (minutosTotales <= 0) return;
      const filaCabecera = document.createElement('tr');
      filaCabecera.innerHTML = `<th>Minuto</th>${columnas.map(n => `<th>${n}</th>`).join('')}`;
      thead.appendChild(filaCabecera);
      for (let i = 1; i <= minutosTotales; i++) {
        const fila = document.createElement('tr');
        fila.innerHTML = `<td>${i}</td>${columnas.map(() => `<td class="celda-inactiva"></td>`).join('')}`;
        tbody.appendChild(fila);
      }
      actualizarAnalisis();
    }

    function actualizarAnalisis() {
      divAnalisis.innerHTML = '';
      const minutosTotales = parseInt(inputMinutos.value) || 0;
      columnas.forEach((nombre, indiceColumna) => {
        let celdasActivas = 0;
        for (const fila of tbody.rows) {
          if (!fila.cells[indiceColumna+1].classList.contains('celda-inactiva')) {
            celdasActivas++;
          }
        }
        const tiempoOcioso = minutosTotales - celdasActivas;
        const porcActividad = (celdasActivas / minutosTotales) * 100;
        const p = document.createElement('p');
        p.innerHTML = `<b>${nombre}:</b> ${porcActividad.toFixed(1)}% actividad (${celdasActivas} min), ${tiempoOcioso} min ocioso`;
        divAnalisis.appendChild(p);
      });
    }

    function crearNuevaAccion(nombre, duracion, color) {
      if (!nombre) return;
      const nuevaAccion = { nombre, duracion, color };
      acciones.push(nuevaAccion);
      const btn = document.createElement('button');
      btn.textContent = `${nombre} (${duracion}m)`;
      btn.style.backgroundColor = color;
      btn.onclick = () => { accionActual = nuevaAccion; };
      divAcciones.appendChild(btn);
      inputNombreAccion.value = '';
      inputDuracionAccion.value = 1;
    }

    // Bordes solo externos de bloque
    function aplicarBordes() {
      // reset bordes
      for (const fila of tbody.rows) {
        for (const celda of fila.cells) {
          celda.style.border = '1px solid var(--borde-color)';
        }
      }
      const bloques = {};
      tbody.querySelectorAll('td[data-block-id]').forEach(c => {
        const id = c.dataset.blockId;
        if (!bloques[id]) bloques[id] = [];
        bloques[id].push(c);
      });
      Object.values(bloques).forEach(celdas => {
        celdas.sort((a,b)=>a.parentElement.rowIndex-b.parentElement.rowIndex);
        const primera=celdas[0], ultima=celdas[celdas.length-1];
        celdas.forEach(c=>{
          c.style.borderLeft='2px solid black';
          c.style.borderRight='2px solid black';
          c.style.borderTop='none';
          c.style.borderBottom='none';
        });
        primera.style.borderTop='2px solid black';
        ultima.style.borderBottom='2px solid black';
      });
    }

    // Eventos de pintar/editar
    tabla.addEventListener('click', e=>{
      const celda=e.target;
      if(celda.tagName!=='TD'||celda.cellIndex===0)return;
      if(celda.dataset.blockId){
        nombreAccionEditando=celda.dataset.accion;
        blockIdEditando=celda.dataset.blockId;
        inputNuevoNombre.value=nombreAccionEditando;
        modalEditar.style.display='flex';
        return;
      }
      if(!accionActual){alert('Selecciona una acción');return;}
      const filas=tbody.rows;
      const filaIndex=Array.from(filas).indexOf(celda.parentElement);
      const colIndex=celda.cellIndex;
      const duracion=accionActual.duracion||1;
      const middleIndex=Math.floor((duracion-1)/2);
      const blockId=Date.now()+"-"+Math.random();
      for(let i=0;i<duracion;i++){
        const f=filaIndex+i;
        if(f>=filas.length)break;
        const c=filas[f].cells[colIndex];
        c.className='';
        c.style.backgroundColor=accionActual.color;
        c.style.color='white';
        c.dataset.accion=accionActual.nombre;
        c.dataset.blockId=blockId;
        c.textContent=(i===middleIndex)?accionActual.nombre:'';
      }
      aplicarBordes();
      actualizarAnalisis();
    });

    btnGuardarNombre.onclick=()=>{
      const nuevo=inputNuevoNombre.value.trim();
      if(nuevo&&blockIdEditando){
        tbody.querySelectorAll(`td[data-block-id="${blockIdEditando}"]`).forEach(c=>{
          c.dataset.accion=nuevo;
          if(c.textContent===nombreAccionEditando)c.textContent=nuevo;
        });
      }
      modalEditar.style.display='none';
      aplicarBordes();
    };
    btnCancelarNombre.onclick=()=>modalEditar.style.display='none';

    btnGenerar.onclick=()=>{generarTabla();aplicarBordes();};
    btnAgregarMaquina.onclick=()=>{
      const nombre=`M${columnas.length}`;
      columnas.push(nombre);
      generarTabla();
    };
    btnCrearAccion.onclick=()=>{
      crearNuevaAccion(inputNombreAccion.value,parseInt(inputDuracionAccion.value)||1,inputColorAccion.value);
    };

    generarTabla();
  </script>
</body>
</html>
