<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Diagrama Hombre-Máquina Avanzado</title>
    <style>
        :root {
            --borde-color: #dee2e6;
            --fondo-gris: #f8f9fa;
            --azul-principal: #0d6efd;
            --rojo-peligro: #dc3545;
            --texto-claro: #fff;
            --gris-oscuro: #6c757d;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--fondo-gris);
            color: #212529;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }
        main {
            width: 100%;
            max-width: 900px;
            background-color: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h2, h3 {
            border-bottom: 2px solid var(--borde-color);
            padding-bottom: 10px;
            margin-top: 0;
        }

        .seccion { margin-bottom: 25px; padding: 20px; border: 1px solid var(--borde-color); border-radius: 5px; }
        .control-grupo, .accion-grupo { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-bottom: 15px; }
        input[type="number"], input[type="text"], input[type="color"] { padding: 8px 12px; border: 1px solid var(--borde-color); border-radius: 4px; font-size: 1rem; }
        input#duracionAccion { width: 80px; }
        button { padding: 8px 15px; border: none; border-radius: 4px; color: var(--texto-claro); font-weight: bold; cursor: pointer; transition: opacity 0.2s; }
        button:hover { opacity: 0.85; }
        .btn-principal { background-color: var(--azul-principal); }
        .btn-rojo { background-color: var(--rojo-peligro); }
        .btn-secundario { background-color: var(--gris-oscuro); }
        #acciones-disponibles { margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap; }

        .tabla-contenedor { max-height: 600px; overflow-y: auto; border: 1px solid var(--borde-color); }
        table { width: 100%; border-collapse: collapse; text-align: center; }
        th, td { border: 1px solid var(--borde-color); padding: 5px; min-width: 80px; height: 25px; font-size: 0.9rem; }
        td[data-accion] { font-weight: bold; font-size: 0.8em; vertical-align: middle; cursor: pointer; }
        thead th { position: sticky; top: 0; background-color: #e9ecef; }
        tbody td:first-child { font-weight: bold; background-color: var(--fondo-gris); }
        .celda-inactiva {
            background-image: repeating-linear-gradient(45deg, rgba(220, 53, 69, 0.08), rgba(220, 53, 69, 0.08) 8px, transparent 8px, transparent 16px);
        }

        /* Borde para las celdas del mismo bloque (estilo simple) */
        .borde-accion {
            border: 2px solid black !important;
        }

        /* Modal para renombrar acción */
        #modalEditar {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }
        #modalContenido {
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 420px;
        }
        #modalContenido input {
            padding: 8px;
            font-size: 1rem;
            margin-bottom: 10px;
            width: 100%;
            box-sizing: border-box;
            border: 1px solid var(--borde-color);
            border-radius: 6px;
        }

        /* Tooltip pequeño */
        #tooltip {
            position: absolute;
            visibility: hidden;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px 8px;
            z-index: 10;
            opacity: 0;
            transition: opacity 0.15s;
            font-size: 0.85rem;
        }
    </style>
</head>
<body>
    <div id="tooltip"></div>
    <main>
        <h2>Diagrama Hombre-Máquina Avanzado</h2>

        <div class="seccion">
            <h3>Configuración</h3>
            <div class="control-grupo">
                <label for="minutos">Minutos Totales:</label>
                <input type="number" id="minutos" value="60">
                <button id="btnGenerar" class="btn-principal">Generar / Reiniciar</button>
                <button id="btnAgregarMaquina" class="btn-principal">+ Máquina</button>
            </div>
            <div class="control-grupo">
                 <button id="btnGuardar" class="btn-secundario">💾 Guardar Diagrama</button>
                 <button id="btnCargar" class="btn-secundario">📂 Cargar Diagrama</button>
                 <input type="file" id="inputCargar" accept=".json" style="display: none;">
            </div>
        </div>
        
        <div class="seccion">
            <h3>Acciones</h3>
            <div class="accion-grupo">
                <input type="text" id="nombreAccion" placeholder="Nombre de acción">
                <input type="number" id="duracionAccion" placeholder="Min" min="1" value="1" title="Duración en minutos">
                <input type="color" id="colorAccion" value="#4caf50">
                <button id="btnCrearAccion" class="btn-principal">Crear Acción</button>
                <button id="btnModoEliminar" class="btn-rojo">Activar Modo Eliminar</button>
            </div>
            <div id="acciones-disponibles"></div>
        </div>

        <div class="seccion">
            <h3>Análisis de Actividad</h3>
            <div id="analisis-container"><p>Genera la tabla para ver el análisis.</p></div>
        </div>

        <div class="tabla-contenedor">
            <table id="tabla-actividades">
                <thead></thead>
                <tbody></tbody>
            </table>
        </div>
    </main>

    <!-- Modal editar nombre -->
    <div id="modalEditar">
        <div id="modalContenido">
            <h3>Editar nombre de la acción</h3>
            <input type="text" id="inputNuevoNombre" />
            <div style="margin-top:12px;">
                <button id="btnGuardarNombre" class="btn-principal">Guardar</button>
                <button id="btnCancelarNombre" class="btn-rojo">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
    // --- ELEMENTOS DEL DOM ---
    const tooltip = document.getElementById('tooltip');
    const inputMinutos = document.getElementById('minutos');
    const btnGenerar = document.getElementById('btnGenerar');
    const btnAgregarMaquina = document.getElementById('btnAgregarMaquina');
    const inputNombreAccion = document.getElementById('nombreAccion');
    const inputDuracionAccion = document.getElementById('duracionAccion');
    const inputColorAccion = document.getElementById('colorAccion');
    const btnCrearAccion = document.getElementById('btnCrearAccion');
    const btnModoEliminar = document.getElementById('btnModoEliminar');
    const divAcciones = document.getElementById('acciones-disponibles');
    const divAnalisis = document.getElementById('analisis-container');
    const tabla = document.getElementById('tabla-actividades');
    const thead = tabla.querySelector('thead');
    const tbody = tabla.querySelector('tbody');
    const btnGuardar = document.getElementById('btnGuardar');
    const btnCargar = document.getElementById('btnCargar');
    const inputCargar = document.getElementById('inputCargar');

    // Modal
    const modalEditar = document.getElementById('modalEditar');
    const inputNuevoNombre = document.getElementById('inputNuevoNombre');
    const btnGuardarNombre = document.getElementById('btnGuardarNombre');
    const btnCancelarNombre = document.getElementById('btnCancelarNombre');

    // --- ESTADO ---
    let columnas = ['Hombre'];
    let acciones = []; // {nombre, duracion, color}
    let accionActual = null;
    let modoEliminar = false;
    let nombreAccionEditando = null;

    // --- FUNCIONES --- 

    function generarTabla() {
        thead.innerHTML = '';
        tbody.innerHTML = '';
        const minutosTotales = parseInt(inputMinutos.value) || 0;
        if (minutosTotales <= 0) return;
        const filaCabecera = document.createElement('tr');
        filaCabecera.innerHTML = `<th>Minuto</th>${columnas.map(n => `<th>${n}</th>`).join('')}`;
        thead.appendChild(filaCabecera);
        for (let i = 1; i <= minutosTotales; i++) {
            const fila = document.createElement('tr');
            fila.innerHTML = `<td>${i}</td>${columnas.map(() => `<td class="celda-inactiva"></td>`).join('')}`;
            tbody.appendChild(fila);
        }
        actualizarAnalisis();
        aplicarBordes();
    }

    function actualizarAnalisis() {
        divAnalisis.innerHTML = '';
        const minutosTotales = parseInt(inputMinutos.value) || 0;
        if (minutosTotales === 0) {
            divAnalisis.innerHTML = '<p>No hay minutos para analizar.</p>';
            return;
        }
        columnas.forEach((nombre, indiceColumna) => {
            let celdasActivas = 0;
            for (const fila of tbody.rows) {
                if (!fila.cells[indiceColumna + 1].classList.contains('celda-inactiva')) {
                    celdasActivas++;
                }
            }
            const tiempoOcioso = minutosTotales - celdasActivas;
            const porcActividad = (celdasActivas / minutosTotales) * 100;
            const porcOcioso = (tiempoOcioso / minutosTotales) * 100;

            const p = document.createElement('p');
            p.innerHTML = `<b>${nombre}:</b> ${porcActividad.toFixed(1)}% Actividad (${celdasActivas} min) | <span style="color: #dc3545;">${porcOcioso.toFixed(1)}% Ocioso (${tiempoOcioso} min)</span>`;
            divAnalisis.appendChild(p);
        });
    }

    function crearBotonAccion(objAccion, esHerramienta = false) {
        const btnAccion = document.createElement('button');
        btnAccion.textContent = esHerramienta ? objAccion.nombre : `${objAccion.nombre} (${objAccion.duracion}m)`;
        btnAccion.style.backgroundColor = objAccion.color;
        btnAccion.style.border = '2px solid transparent';
        btnAccion.addEventListener('click', () => {
            if (modoEliminar && !esHerramienta) {
                if (confirm(`¿Estás seguro de que quieres eliminar la acción "${objAccion.nombre}"?`)) {
                    eliminarAccion(objAccion);
                }
            } else {
                accionActual = objAccion;
                document.querySelectorAll('#acciones-disponibles button').forEach(btn => btn.style.borderColor = 'transparent');
                btnAccion.style.borderColor = '#000';
            }
        });
        return btnAccion;
    }

    function crearNuevaAccion(nombre, duracion, color, esHerramienta = false) {
        if (!nombre) {
            alert('Por favor, introduce un nombre para la acción.');
            return;
        }
        const nuevaAccion = { nombre, duracion, color };
        if (!esHerramienta) acciones.push(nuevaAccion);
        const btn = crearBotonAccion(nuevaAccion, esHerramienta);
        divAcciones.appendChild(btn);
        if (!esHerramienta) {
             inputNombreAccion.value = '';
             inputDuracionAccion.value = '1';
        }
    }

    function inicializarAcciones() {
        // Limpiar UI luego volver a crear: Borrador + todas las acciones en `acciones`
        divAcciones.innerHTML = '';
        // Borrador (herramienta)
        const objBorrador = { nombre: 'Borrador', duracion: 1, color: '#6c757d' };
        const btnBorrador = crearBotonAccion(objBorrador, true);
        divAcciones.appendChild(btnBorrador);

        // Botones basados en `acciones`
        acciones.forEach(acc => {
            const btn = crearBotonAccion(acc, false);
            divAcciones.appendChild(btn);
        });
    }

    function eliminarAccion(accionAEliminar) {
        // Limpiar celdas con esa acción
        for (const fila of tbody.rows) {
            for (const celda of fila.cells) {
                if (celda.dataset.accion === accionAEliminar.nombre) {
                    limpiarCelda(celda);
                }
            }
        }
        acciones = acciones.filter(a => a.nombre !== accionAEliminar.nombre);
        // refrescar UI de acciones
        inicializarAcciones();
        if (accionActual && accionActual.nombre === accionAEliminar.nombre) accionActual = null;
        actualizarAnalisis();
        aplicarBordes();
    }

    function getContrastingTextColor(hexColor) {
        if (!hexColor) return 'white';
        if (hexColor.startsWith('#')) hexColor = hexColor.slice(1);
        const r = parseInt(hexColor.substr(0, 2), 16);
        const g = parseInt(hexColor.substr(2, 2), 16);
        const b = parseInt(hexColor.substr(4, 2), 16);
        const yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
        return (yiq >= 128) ? 'black' : 'white';
    }

    function limpiarCelda(celda) {
        celda.className = 'celda-inactiva';
        celda.style.backgroundColor = '';
        celda.style.color = '';
        celda.textContent = '';
        delete celda.dataset.accion;
    }

    // Aplica la clase borde a todas las celdas que pertenezcan a una misma acción
    // (simple: aplica borde a cada celda del bloque).
    function aplicarBordes() {
        for (const fila of tbody.rows) {
            for (const celda of fila.cells) {
                celda.classList.remove('borde-accion');
            }
        }
        const accionesUnicas = [...new Set(
            Array.from(tbody.querySelectorAll('td[data-accion]')).map(c => c.dataset.accion)
        )];
        accionesUnicas.forEach(nombre => {
            const grupo = Array.from(tbody.querySelectorAll(`td[data-accion="${nombre}"]`));
            if (grupo.length > 0) {
                grupo.forEach(c => c.classList.add('borde-accion'));
            }
        });
    }

    // --- FUNCIONALIDAD: AGREGAR MÁQUINA ---
    function agregarMaquina() {
        // Default sugerido M1, M2, ... según número actual de máquinas (excluye "Hombre")
        const sugerencia = `M${columnas.length}`; // columnas incluye 'Hombre' al inicio
        const nombreMaquina = prompt("Introduce el nombre de la nueva máquina:", sugerencia);
        if (!nombreMaquina) return;
        if (columnas.includes(nombreMaquina)) {
            alert("Ese nombre ya existe.");
            return;
        }
        columnas.push(nombreMaquina);
        generarTabla();
    }

    // --- EVENTOS TABLA (pintar / editar nombre) ---
    tabla.addEventListener('click', function(event) {
        const celda = event.target;
        if (celda.tagName !== 'TD' || celda.cellIndex === 0) return;

        // Si la celda ya pertenece a una acción → abrir modal para renombrar
        if (celda.dataset.accion) {
            nombreAccionEditando = celda.dataset.accion;
            inputNuevoNombre.value = nombreAccionEditando;
            modalEditar.style.display = 'flex';
            inputNuevoNombre.focus();
            return;
        }

        // Si es celda inactiva: pintar con la acción seleccionada
        const filas = tbody.rows;
        const indiceFila = Array.from(filas).indexOf(celda.parentElement);
        const indiceColumna = celda.cellIndex;

        // Borrador es una herramienta que se selecciona entre botones; si está activa, limpiar
        if (accionActual && accionActual.nombre === 'Borrador') {
            limpiarCelda(celda);
            actualizarAnalisis();
            aplicarBordes();
            return;
        }

        if (celda.classList.contains('celda-inactiva')) {
            if (!accionActual) {
                alert("Por favor, selecciona una acción primero.");
                return;
            }
            const duracion = accionActual.duracion || 1;
            const middleIndex = Math.floor((duracion - 1) / 2);
            const textColor = getContrastingTextColor(accionActual.color);

            for (let i = 0; i < duracion; i++) {
                const filaIndex = indiceFila + i;
                if (filaIndex >= filas.length) break;

                const celdaAPintar = filas[filaIndex].cells[indiceColumna];
                celdaAPintar.className = '';
                celdaAPintar.style.backgroundColor = accionActual.color;
                celdaAPintar.style.color = textColor;
                celdaAPintar.dataset.accion = accionActual.nombre;
                celdaAPintar.textContent = (i === middleIndex) ? accionActual.nombre : '';
            }
        } else {
            // Si ya estaba pintada (pero no abrimos modal) -> limpiarla (esto sucede si alguna configuración previa lo permitía)
            limpiarCelda(celda);
        }
        actualizarAnalisis();
        aplicarBordes();
    });

    // Tooltip al pasar el mouse por celdas con acción
    tabla.addEventListener('mouseover', (event) => {
        if (event.target.tagName === 'TD' && event.target.dataset.accion) {
            tooltip.textContent = event.target.dataset.accion;
            tooltip.style.left = `${event.pageX + 10}px`;
            tooltip.style.top = `${event.pageY + 10}px`;
            tooltip.style.visibility = 'visible';
            tooltip.style.opacity = 1;
        }
    });
    tabla.addEventListener('mousemove', (event) => {
        if (tooltip.style.visibility === 'visible') {
            tooltip.style.left = `${event.pageX + 10}px`;
            tooltip.style.top = `${event.pageY + 10}px`;
        }
    });
    tabla.addEventListener('mouseout', () => {
        tooltip.style.visibility = 'hidden';
        tooltip.style.opacity = 0;
    });

    // --- Modal: guardar nuevo nombre ---
    btnGuardarNombre.addEventListener('click', () => {
        const nuevoNombre = inputNuevoNombre.value.trim();
        if (!nuevoNombre || !nombreAccionEditando) {
            modalEditar.style.display = 'none';
            return;
        }
        // Evitar nombres duplicados
        const existeEnAcciones = acciones.some(a => a.nombre === nuevoNombre);
        if (existeEnAcciones) {
            alert('Ya existe otra acción con ese nombre. Elige otro.');
            return;
        }

        // Cambiar en la tabla
        tbody.querySelectorAll(`td[data-accion="${nombreAccionEditando}"]`).forEach(c => {
            // actualizar dataset
            c.dataset.accion = nuevoNombre;
            // actualizar texto solo si era el centro que mostraba el nombre
            if (c.textContent === nombreAccionEditando) c.textContent = nuevoNombre;
        });

        // Cambiar en el array de acciones y en los botones
        const acc = acciones.find(a => a.nombre === nombreAccionEditando);
        if (acc) {
            acc.nombre = nuevoNombre;
        }
        // Si la acción renombrada estaba seleccionada como accionActual, actualizar referencia
        if (accionActual && accionActual.nombre === nombreAccionEditando) {
            accionActual = acc || { nombre: nuevoNombre };
        }

        // Reconstruir UI de botones de acciones para reflejar el nuevo nombre
        inicializarAcciones();

        modalEditar.style.display = 'none';
        aplicarBordes();
    });

    btnCancelarNombre.addEventListener('click', () => {
        modalEditar.style.display = 'none';
    });

    // --- Guardar / Cargar ---
    btnGuardar.addEventListener('click', () => {
        const estado = {
            columnas: columnas,
            acciones: acciones,
            minutosTotales: inputMinutos.value,
            tablaData: Array.from(tbody.rows).map(fila =>
                Array.from(fila.cells).slice(1).map(celda => celda.dataset.accion || null)
            )
        };
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(estado, null, 2));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", "diagrama-hombre-maquina.json");
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    });

    btnCargar.addEventListener('click', () => inputCargar.click());

    inputCargar.addEventListener('change', (event) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const estadoCargado = JSON.parse(e.target.result);
                columnas = estadoCargado.columnas || ['Hombre'];
                acciones = estadoCargado.acciones || [];
                inputMinutos.value = estadoCargado.minutosTotales || inputMinutos.value;

                // Reconstruir acciones UI
                inicializarAcciones();

                // Generar tabla y repoblar
                generarTabla();
                const filas = tbody.rows;
                (estadoCargado.tablaData || []).forEach((filaData, indiceFila) => {
                    filaData.forEach((nombreAccion, indiceColumna) => {
                        if (nombreAccion) {
                            const accion = acciones.find(a => a.nombre === nombreAccion);
                            const celda = filas[indiceFila].cells[indiceColumna + 1];
                            if (accion) {
                                celda.className = '';
                                celda.style.backgroundColor = accion.color;
                                celda.style.color = getContrastingTextColor(accion.color);
                                celda.dataset.accion = accion.nombre;
                                // texto se deja simple; al menos la central mostrará nombre si corresponde
                            }
                        }
                    });
                });

                actualizarAnalisis();
                aplicarBordes();
            } catch (err) {
                alert('Error al cargar el archivo: formato inválido.');
                console.error(err);
            }
        };
        if (event.target.files && event.target.files[0]) {
            reader.readAsText(event.target.files[0]);
        }
        inputCargar.value = ''; // reset
    });

    // --- Botones y comportamientos ---
    btnGenerar.addEventListener('click', generarTabla);
    btnAgregarMaquina.addEventListener('click', agregarMaquina);
    btnCrearAccion.addEventListener('click', () => {
        const duracion = parseInt(inputDuracionAccion.value) || 1;
        crearNuevaAccion(inputNombreAccion.value.trim(), duracion, inputColorAccion.value);
    });

    btnModoEliminar.addEventListener('click', () => {
        modoEliminar = !modoEliminar;
        if (modoEliminar) {
            btnModoEliminar.textContent = 'Modo Eliminar ACTIVADO';
            btnModoEliminar.style.backgroundColor = '#ffc107';
            btnModoEliminar.style.color = '#000';
            alert('Modo Eliminar Activado: Haz clic en una acción para borrarla.');
        } else {
            btnModoEliminar.textContent = 'Activar Modo Eliminar';
            btnModoEliminar.style.backgroundColor = 'var(--rojo-peligro)';
            btnModoEliminar.style.color = '#fff';
        }
    });

    // --- INICIALIZACIÓN ---
    function inicializar() {
        // Acciones base
        crearNuevaAccion('Trabajo', 1, '#0d6efd');
        crearNuevaAccion('Espera', 1, '#ffc107');
        // Reconstruir UI de botones (incluye Borrador)
        inicializarAcciones();
        generarTabla();
        // Seleccionar primera acción real (no el borrador)
        // divAcciones.children[0] => Borrador; children[1] => primera acción
        if (divAcciones.children[1]) {
            divAcciones.children[1].click();
        }
    }

    inicializar();
    </script>
</body>
</html>
