<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagrama H-M Visual e Interactivo</title>
    <style>
        :root {
            --cell-size: 30px;
            --border-color: #e0e0e0;
            --header-bg: #34495e;
            --tool-bg: #ecf0f1;
            --task-load: rgba(52, 152, 219, 0.9); /* Azul */
            --task-unload: rgba(46, 204, 113, 0.9); /* Verde */
            --task-machining: rgba(241, 196, 15, 0.9); /* Amarillo */
            --task-transport: rgba(155, 89, 182, 0.9); /* Morado */
            --task-idle: rgba(189, 195, 199, 0.8); /* Gris */
        }
        body {
            font-family: system-ui, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #f4f7f9;
        }
        .container {
            width: 95%;
            max-width: 1400px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        h1 { color: #2c3e50; text-align: center; }

        /* --- CONTROLES Y HERRAMIENTAS --- */
        .controls {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            padding: 15px;
            background: var(--tool-bg);
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .tool-group {
            margin: 5px 15px;
        }
        .tool-group label { font-weight: bold; margin-right: 10px; }
        .task-btn {
            padding: 8px 12px;
            border: 2px solid transparent;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            color: white;
            margin: 2px;
        }
        .task-btn.active {
            border-color: #3498db;
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.5);
        }
        #btn-load { background-color: var(--task-load); }
        #btn-unload { background-color: var(--task-unload); }
        #btn-machining { background-color: var(--task-machining); }
        #btn-transport { background-color: var(--task-transport); }
        #btn-idle { background-color: var(--task-idle); }
        #btn-delete { background-color: #e74c3c; }

        /* --- DIAGRAMA GRID --- */
        #chart-wrapper { overflow-x: auto; }
        #chart-grid {
            display: grid;
            border-left: 1px solid var(--border-color);
            border-top: 1px solid var(--border-color);
        }
        .grid-header, .grid-cell, .time-label {
            height: var(--cell-size);
            min-width: 120px; /* Ancho de columna */
            box-sizing: border-box;
        }
        .grid-header {
            background-color: var(--header-bg);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            position: sticky; top: 0;
        }
        .grid-cell {
            border-right: 1px solid var(--border-color);
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
        }
        .grid-cell:hover { background-color: #f0f8ff; }

        /* --- BLOQUES DE TAREA --- */
        .task-block {
            position: absolute;
            width: 120px; /* Igual al min-width de celda */
            box-sizing: border-box;
            background: #ccc;
            border: 1px solid rgba(0,0,0,0.2);
            border-radius: 4px;
            color: white;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none; /* Para poder hacer clic "a trav√©s" de √©l para eliminar */
            z-index: 10;
        }
        
        /* --- TOTALES --- */
        #totals { margin-top: 20px; }
    </style>
</head>
<body>

<div class="container">
    <h1>Diagrama Hombre-M√°quina Visual ‚úçÔ∏è</h1>

    <div class="controls">
        <div class="tool-group">
            <label>1. Elige una Tarea:</label>
            <button class="task-btn" id="btn-load" data-task="load" data-entity="hombre">Cargar</button>
            <button class="task-btn" id="btn-unload" data-task="unload" data-entity="hombre">Descargar</button>
            <button class="task-btn" id="btn-transport" data-task="transport" data-entity="hombre">Transporte</button>
            <button class="task-btn" id="btn-machining" data-task="machining" data-entity="maquina">Maquinado</button>
            <button class="task-btn" id="btn-idle" data-task="idle" data-entity="ambos">Espera</button>
        </div>
        <div class="tool-group">
            <label>Herramienta:</label>
            <button class="task-btn" id="btn-delete">Eliminar Tarea</button>
        </div>
    </div>
    
    <div id="chart-wrapper">
        <div id="chart-grid"></div>
    </div>

    <div id="totals">
        <h2>üìä Resumen de Tiempos</h2>
        <table id="totals-table" style="width:100%; border-collapse: collapse;"></table>
    </div>
</div>

<script>
    // --- CONFIGURACI√ìN INICIAL ---
    const NUM_MACHINES = 3;
    const TOTAL_TIME_UNITS = 30; // 30 "minutos" o filas
    const COLUMNS = ['Hombre', ...Array.from({ length: NUM_MACHINES }, (_, i) => `M√°quina ${i + 1}`)];
    
    // --- ESTADO DE LA APLICACI√ìN ---
    let activeTool = { type: 'task', task: 'load', entity: 'hombre' };
    let tasks = [];

    // --- ELEMENTOS DEL DOM ---
    const grid = document.getElementById('chart-grid');
    const toolButtons = document.querySelectorAll('.task-btn');

    // --- L√ìGICA DE LA APLICACI√ìN ---
    function initialize() {
        setupGrid();
        setupEventListeners();
        setActiveTool(document.getElementById('btn-load'));
    }

    function setupGrid() {
        grid.innerHTML = '';
        grid.style.gridTemplateColumns = `repeat(${COLUMNS.length}, 1fr)`;

        // 1. Crear cabeceras
        COLUMNS.forEach(colName => {
            const header = document.createElement('div');
            header.className = 'grid-header';
            header.textContent = colName;
            grid.appendChild(header);
        });

        // 2. Crear celdas de la cuadr√≠cula
        for (let row = 0; row < TOTAL_TIME_UNITS; row++) {
            for (let col = 0; col < COLUMNS.length; col++) {
                const cell = document.createElement('div');
                cell.className = 'grid-cell';
                cell.dataset.row = row;
                cell.dataset.col = col;
                grid.appendChild(cell);
            }
        }
    }

    function setupEventListeners() {
        toolButtons.forEach(btn => {
            btn.addEventListener('click', () => setActiveTool(btn));
        });

        grid.addEventListener('click', (e) => {
            if (!e.target.classList.contains('grid-cell')) return;

            const cell = e.target;
            const { row, col } = cell.dataset;
            
            if (activeTool.type === 'delete') {
                deleteTaskAt(parseInt(row), parseInt(col));
            } else {
                addTask(parseInt(row), parseInt(col));
            }
        });
    }

    function setActiveTool(button) {
        toolButtons.forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');
        
        if (button.id === 'btn-delete') {
            activeTool = { type: 'delete' };
            grid.style.cursor = 'crosshair';
        } else {
            activeTool = {
                type: 'task',
                task: button.dataset.task,
                entity: button.dataset.entity
            };
            grid.style.cursor = 'pointer';
        }
    }

    function addTask(startRow, col) {
        const durationStr = prompt(`Duraci√≥n de la tarea "${activeTool.task}" (en minutos/filas):`, "3");
        const duration = parseInt(durationStr);
        if (isNaN(duration) || duration <= 0) return;

        const newTask = {
            id: Date.now(),
            task: activeTool.task,
            entity: activeTool.entity,
            col,
            startRow,
            duration,
        };
        
        // Asignar a la columna correcta (Hombre o M√°quina)
        let targetCol = col;
        if (newTask.entity === 'hombre') targetCol = 0;
        else if (newTask.entity === 'maquina') {
            if (col === 0) {
                alert('La tarea de "Maquinado" solo puede asignarse a una columna de M√°quina.');
                return;
            }
            targetCol = col;
        }
        
        newTask.col = targetCol;

        // Validar si el espacio est√° ocupado
        for(let i=0; i < duration; i++){
            if(isOccupied(startRow + i, targetCol)){
                alert('El espacio de tiempo ya est√° ocupado. No se puede a√±adir la tarea.');
                return;
            }
        }
        
        tasks.push(newTask);
        render();
    }
    
    function isOccupied(row, col){
        return tasks.some(t => t.col === col && row >= t.startRow && row < t.startRow + t.duration);
    }

    function deleteTaskAt(row, col) {
        tasks = tasks.filter(t => !(t.col === col && row >= t.startRow && row < t.startRow + t.duration));
        render();
    }
    
    function render() {
        // Limpiar bloques de tareas existentes
        document.querySelectorAll('.task-block').forEach(block => block.remove());

        // Dibujar cada tarea
        tasks.forEach(task => {
            const block = document.createElement('div');
            block.className = 'task-block';
            block.style.gridColumn = task.col + 1;
            block.style.gridRow = `${task.startRow + 2} / span ${task.duration}`;
            block.style.position = 'relative'; // Reset position within grid cell
            block.style.top = `calc(${task.startRow} * var(--cell-size))`;
            block.style.left = `calc(${task.col} * (100% / ${COLUMNS.length}))`;
            block.style.height = `calc(${task.duration} * var(--cell-size))`;
            block.style.backgroundColor = `var(--task-${task.task})`;
            block.textContent = `${task.task.charAt(0).toUpperCase() + task.task.slice(1)}`;
            
            // Usamos un contenedor diferente para los bloques para que no interfieran con los clics del grid
            document.body.appendChild(block);
            const gridRect = grid.getBoundingClientRect();
            const bodyRect = document.body.getBoundingClientRect();
            block.style.position = 'absolute';
            block.style.top = `calc(${gridRect.top - bodyRect.top} + var(--cell-size) * ${task.startRow + 1}px)`;
            block.style.left = `calc(${gridRect.left - bodyRect.left} + ${task.col} * (100% / ${COLUMNS.length}))`;
        });
        
        updateTotals();
    }
    
    function updateTotals() {
        const totalsTable = document.getElementById('totals-table');
        let totals = {};
        COLUMNS.forEach((col, index) => {
            totals[index] = { working: 0, idle: 0, name: col };
        });

        tasks.forEach(task => {
            if (task.task === 'idle') {
                totals[task.col].idle += task.duration;
            } else {
                totals[task.col].working += task.duration;
            }
        });

        let tableHTML = `
            <tr style="background-color: var(--header-bg); color: white;">
                <th>Recurso</th><th>Tiempo Trabajando</th><th>Tiempo de Espera</th><th>Tiempo Total</th><th>% Utilizaci√≥n</th>
            </tr>`;
        
        Object.values(totals).forEach(data => {
            const totalTime = data.working + data.idle;
            const utilization = TOTAL_TIME_UNITS > 0 ? (data.working / TOTAL_TIME_UNITS * 100).toFixed(1) : 0;
            tableHTML += `
                <tr style="text-align: center; border-bottom: 1px solid #ddd;">
                    <td><strong>${data.name}</strong></td>
                    <td>${data.working} min</td>
                    <td>${data.idle} min</td>
                    <td>${totalTime} min</td>
                    <td style="font-weight: bold; color: ${utilization > 75 ? 'green' : 'orange'};">${utilization}%</td>
                </tr>
            `;
        });
        totalsTable.innerHTML = tableHTML;
    }

    // Iniciar la aplicaci√≥n
    initialize();
</script>
</body>
</html>
