    <script>
    // --- ELEMENTOS DEL DOM ---
    const tooltip = document.getElementById('tooltip');
    const inputMinutos = document.getElementById('minutos');
    const btnGenerar = document.getElementById('btnGenerar');
    const btnAgregarMaquina = document.getElementById('btnAgregarMaquina');
    const inputNombreAccion = document.getElementById('nombreAccion');
    const inputDuracionAccion = document.getElementById('duracionAccion');
    const inputColorAccion = document.getElementById('colorAccion');
    const btnCrearAccion = document.getElementById('btnCrearAccion');
    const btnModoEliminar = document.getElementById('btnModoEliminar');
    const divAcciones = document.getElementById('acciones-disponibles');
    const divAnalisis = document.getElementById('analisis-container');
    const tabla = document.getElementById('tabla-actividades');
    const thead = tabla.querySelector('thead');
    const tbody = tabla.querySelector('tbody');
    const btnGuardar = document.getElementById('btnGuardar');
    const btnCargar = document.getElementById('btnCargar');
    const inputCargar = document.getElementById('inputCargar');

    // --- ESTADO DE LA APLICACIÓN ---
    let columnas = ['Hombre'];
    let acciones = [];
    let accionActual = null;
    let modoEliminar = false;
    // --- CAMBIO: Añadimos un contador para identificar bloques de acción únicos ---
    let blockIdCounter = 0;

    // --- FUNCIONES ---

    function generarTabla() { /* ... (Sin cambios) ... */
        thead.innerHTML = '';
        tbody.innerHTML = '';
        const minutosTotales = parseInt(inputMinutos.value) || 0;
        if (minutosTotales <= 0) return;
        const filaCabecera = document.createElement('tr');
        filaCabecera.innerHTML = `<th>Minuto</th>${columnas.map(n => `<th>${n}</th>`).join('')}`;
        thead.appendChild(filaCabecera);
        for (let i = 1; i <= minutosTotales; i++) {
            const fila = document.createElement('tr');
            fila.innerHTML = `<td>${i}</td>${columnas.map(() => `<td class="celda-inactiva"></td>`).join('')}`;
            tbody.appendChild(fila);
        }
        actualizarAnalisis();
    }

    function actualizarAnalisis() { /* ... (Sin cambios) ... */
        divAnalisis.innerHTML = '';
        const minutosTotales = parseInt(inputMinutos.value) || 0;
        if (minutosTotales === 0) {
            divAnalisis.innerHTML = '<p>No hay minutos para analizar.</p>';
            return;
        }
        columnas.forEach((nombre, indiceColumna) => {
            let celdasActivas = 0;
            for (const fila of tbody.rows) {
                if (!fila.cells[indiceColumna + 1].classList.contains('celda-inactiva')) {
                    celdasActivas++;
                }
            }
            const tiempoOcioso = minutosTotales - celdasActivas;
            const porcActividad = (celdasActivas / minutosTotales) * 100;
            const porcOcioso = (tiempoOcioso / minutosTotales) * 100;

            const p = document.createElement('p');
            p.innerHTML = `<b>${nombre}:</b> ${porcActividad.toFixed(1)}% Actividad (${celdasActivas} min) | <span style="color: #dc3545;">${porcOcioso.toFixed(1)}% Ocioso (${tiempoOcioso} min)</span>`;
            divAnalisis.appendChild(p);
        });
    }
    
    function crearNuevaAccion(nombre, duracion, color, esHerramienta = false) { /* ... (Sin cambios) ... */
        if (!nombre) {
            alert('Por favor, introduce un nombre para la acción.');
            return;
        }
        const nuevaAccion = { nombre, duracion, color };
        if (!esHerramienta) {
             acciones.push(nuevaAccion);
        }
        
        const btnAccion = document.createElement('button');
        btnAccion.textContent = esHerramienta ? nombre : `${nombre} (${duracion}m)`;
        btnAccion.style.backgroundColor = color;
        btnAccion.style.border = '2px solid transparent';
        
        btnAccion.addEventListener('click', () => {
            if (modoEliminar && !esHerramienta) {
                if (confirm(`¿Estás seguro de que quieres eliminar la acción "${nuevaAccion.nombre}"?`)) {
                    eliminarAccion(nuevaAccion, btnAccion);
                }
            } else {
                accionActual = nuevaAccion;
                document.querySelectorAll('#acciones-disponibles button').forEach(btn => btn.style.borderColor = 'transparent');
                btnAccion.style.borderColor = '#000';
            }
        });
        divAcciones.appendChild(btnAccion);
        if (!esHerramienta) {
             inputNombreAccion.value = '';
             inputDuracionAccion.value = '1';
        }
    }

    function agregarMaquina() { /* ... (Sin cambios) ... */
        const nombreMaquina = prompt("Introduce el nombre de la nueva máquina:", `M${columnas.length}`);
        if (nombreMaquina && !columnas.includes(nombreMaquina)) {
            columnas.push(nombreMaquina);
            generarTabla();
        } else if (columnas.includes(nombreMaquina)) {
            alert("Ese nombre ya existe.");
        }
    }
    
    function eliminarAccion(accionAEliminar, botonAEliminar) { /* ... (Sin cambios) ... */
        for (const fila of tbody.rows) {
            for (const celda of fila.cells) {
                if (celda.dataset.accion === accionAEliminar.nombre) {
                    limpiarCelda(celda);
                }
            }
        }
        acciones = acciones.filter(a => a.nombre !== accionAEliminar.nombre);
        botonAEliminar.remove();
        if (accionActual && accionActual.nombre === accionAEliminar.nombre) {
            accionActual = null;
        }
        actualizarAnalisis();
    }

    function getContrastingTextColor(hexColor) { /* ... (Sin cambios) ... */
        if (hexColor.startsWith('#')) hexColor = hexColor.slice(1);
        const r = parseInt(hexColor.substr(0, 2), 16);
        const g = parseInt(hexColor.substr(2, 2), 16);
        const b = parseInt(hexColor.substr(4, 2), 16);
        const yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
        return (yiq >= 128) ? 'black' : 'white';
    }
    
    // --- CAMBIO: La función ahora borra también los bordes y el ID del bloque ---
    function limpiarCelda(celda) {
        celda.className = 'celda-inactiva';
        celda.style.backgroundColor = '';
        celda.style.color = '';
        celda.textContent = '';
        celda.style.border = ''; // Limpia todos los bordes a la vez
        delete celda.dataset.accion;
        delete celda.dataset.blockId; // Elimina el identificador del bloque
    }

    // --- MANEJADORES DE EVENTOS ---
    
    // --- CAMBIO RADICAL: Lógica de clic completamente nueva ---
    tabla.addEventListener('click', function(event) {
        const celda = event.target;
        if (celda.tagName !== 'TD' || celda.cellIndex === 0) return;
        
        const filas = Array.from(tbody.rows);
        const indiceFila = filas.indexOf(celda.parentElement);
        const indiceColumna = celda.cellIndex;

        // Lógica del Borrador: Ahora borra el bloque entero
        if (accionActual && accionActual.nombre === 'Borrador') {
            const blockId = celda.dataset.blockId;
            if (blockId) {
                tbody.querySelectorAll(`td[data-block-id="${blockId}"]`).forEach(limpiarCelda);
            }
            actualizarAnalisis();
            return;
        }

        // Lógica para PINTAR un nuevo bloque
        if (celda.classList.contains('celda-inactiva')) {
            if (!accionActual) {
                alert("Por favor, selecciona una acción primero.");
                return;
            }
            const duracion = accionActual.duracion || 1;
            const middleIndex = Math.floor((duracion - 1) / 2);
            const textColor = getContrastingTextColor(accionActual.color);
            const blockId = `block-${blockIdCounter++}`; // ID único para este bloque

            for (let i = 0; i < duracion; i++) {
                const filaIndex = indiceFila + i;
                if (filaIndex >= filas.length) break;
                
                const celdaAPintar = filas[filaIndex].cells[indiceColumna];
                celdaAPintar.className = '';
                celdaAPintar.style.backgroundColor = accionActual.color;
                celdaAPintar.style.color = textColor;
                celdaAPintar.dataset.accion = accionActual.nombre;
                celdaAPintar.dataset.blockId = blockId; // Asigna el ID del bloque
                celdaAPintar.textContent = (i === middleIndex) ? accionActual.nombre : '';

                // Lógica para dibujar el borde del bloque
                celdaAPintar.style.borderLeft = '2px solid black';
                celdaAPintar.style.borderRight = '2px solid black';
                if (i === 0) {
                    celdaAPintar.style.borderTop = '2px solid black';
                }
                if (i === duracion - 1) {
                    celdaAPintar.style.borderBottom = '2px solid black';
                }
            }
        // Lógica para RENOMBRAR un bloque existente
        } else {
            const nombreActual = celda.dataset.accion;
            const blockId = celda.dataset.blockId;
            if (!blockId) return; // Si no tiene bloque, no hace nada

            const nuevoNombre = prompt("Cambia el nombre de la acción:", nombreActual);
            
            // Si el usuario introduce un nombre nuevo y válido
            if (nuevoNombre && nuevoNombre.trim() !== "") {
                const celdasDelBloque = tbody.querySelectorAll(`td[data-block-id="${blockId}"]`);
                const duracion = celdasDelBloque.length;
                const middleIndex = Math.floor((duracion - 1) / 2);

                celdasDelBloque.forEach((celdaBloque, index) => {
                    celdaBloque.dataset.accion = nuevoNombre; // Actualiza el nombre en el dataset
                    celdaBloque.textContent = (index === middleIndex) ? nuevoNombre : ''; // Actualiza el texto visible
                });
            }
        }
        actualizarAnalisis();
    });

    // NUEVO: Eventos para el tooltip ... (Sin cambios)
    tabla.addEventListener('mouseover', (event) => {
        if (event.target.tagName === 'TD' && event.target.dataset.accion) {
            tooltip.textContent = event.target.dataset.accion;
            tooltip.style.left = `${event.pageX + 10}px`;
            tooltip.style.top = `${event.pageY + 10}px`;
            tooltip.style.visibility = 'visible';
            tooltip.style.opacity = 1;
        }
    });
    tabla.addEventListener('mouseout', () => {
        tooltip.style.visibility = 'hidden';
        tooltip.style.opacity = 0;
    });

    btnGenerar.addEventListener('click', generarTabla);
    btnAgregarMaquina.addEventListener('click', agregarMaquina);
    btnCrearAccion.addEventListener('click', () => {
        const duracion = parseInt(inputDuracionAccion.value) || 1;
        crearNuevaAccion(inputNombreAccion.value, duracion, inputColorAccion.value);
    });

    btnModoEliminar.addEventListener('click', () => { /* ... (Sin cambios) ... */
        modoEliminar = !modoEliminar;
        if (modoEliminar) {
            btnModoEliminar.textContent = 'Modo Eliminar ACTIVADO';
            btnModoEliminar.style.backgroundColor = '#ffc107';
            btnModoEliminar.style.color = '#000';
            alert('Modo Eliminar Activado: Haz clic en una acción para borrarla.');
        } else {
            btnModoEliminar.textContent = 'Activar Modo Eliminar';
            btnModoEliminar.style.backgroundColor = 'var(--rojo-peligro)';
            btnModoEliminar.style.color = '#fff';
        }
    });

    // NUEVO: Lógica para Guardar y Cargar ... (Sin cambios, pero he revisado que funcione con los nuevos cambios)
    btnGuardar.addEventListener('click', () => {
        const estado = {
            columnas: columnas,
            acciones: acciones,
            minutosTotales: inputMinutos.value,
            // Guardamos más datos de la celda para una reconstrucción perfecta
            tablaData: Array.from(tbody.rows).map(fila => 
                Array.from(fila.cells).slice(1).map(celda => ({
                    accion: celda.dataset.accion || null,
                    blockId: celda.dataset.blockId || null,
                    color: celda.style.backgroundColor || null
                }))
            )
        };
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(estado, null, 2));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", "diagrama-hombre-maquina.json");
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    });

    btnCargar.addEventListener('click', () => inputCargar.click());
    
    // --- CAMBIO: Lógica de carga adaptada para reconstruir bordes y nombres personalizados ---
    inputCargar.addEventListener('change', (event) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            const estadoCargado = JSON.parse(e.target.result);
            
            columnas = estadoCargado.columnas;
            acciones = estadoCargado.acciones;
            inputMinutos.value = estadoCargado.minutosTotales;

            divAcciones.innerHTML = '';
            inicializarAcciones(); 
            
            generarTabla();
            const filas = tbody.rows;
            const bloquesProcesados = {}; // Para no recalcular texto y bordes

            estadoCargado.tablaData.forEach((filaData, indiceFila) => {
                filaData.forEach((celdaData, indiceColumna) => {
                    if (celdaData && celdaData.accion) {
                        const celda = filas[indiceFila].cells[indiceColumna + 1];
                        celda.className = '';
                        celda.style.backgroundColor = celdaData.color;
                        celda.style.color = getContrastingTextColor(celdaData.color);
                        celda.dataset.accion = celdaData.accion;
                        celda.dataset.blockId = celdaData.blockId;
                        
                        // Reconstruir bordes y texto al cargar
                        if (celdaData.blockId && !bloquesProcesados[celdaData.blockId]) {
                            const celdasDelBloque = Array.from(tbody.querySelectorAll(`[data-block-id="${celdaData.blockId}"]`));
                            const duracion = celdasDelBloque.length;
                            const middleIndex = Math.floor((duracion - 1) / 2);
                            
                            celdasDelBloque.forEach((celdaBloque, index) => {
                                celdaBloque.textContent = (index === middleIndex) ? celdaData.accion : '';
                                celdaBloque.style.borderLeft = '2px solid black';
                                celdaBloque.style.borderRight = '2px solid black';
                                if (index === 0) celdaBloque.style.borderTop = '2px solid black';
                                if (index === duracion - 1) celdaBloque.style.borderBottom = '2px solid black';
                            });
                            bloquesProcesados[celdaData.blockId] = true;
                        }
                    }
                });
            });
            actualizarAnalisis();
        };
        reader.readAsText(event.target.files[0]);
        inputCargar.value = '';
    });
    
    // --- INICIALIZACIÓN DE LA APP ---
    function inicializarAcciones() {
        crearNuevaAccion('Borrador', 1, '#6c757d', true); // Crear el Borrador
        acciones.forEach(acc => crearNuevaAccion(acc.nombre, acc.duracion, acc.color));
    }

    function inicializar() {
        crearNuevaAccion('Trabajo', 1, '#0d6efd');
        crearNuevaAccion('Espera', 1, '#ffc107');
        divAcciones.innerHTML = ''; // Limpiar acciones de ejemplo
        inicializarAcciones();
        generarTabla();
        if (divAcciones.children[1]) {
            divAcciones.children[1].click();
        }
    }
    
    inicializar();
        </script>
        
